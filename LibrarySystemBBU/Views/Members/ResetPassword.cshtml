@model Guid
@{
    ViewData["Title"] = "Reset Member Password";
    var memberName = ViewBag.MemberName as string ?? "Member";
}
<link rel="stylesheet" href="~/font-awesome/css/all.min.css" />

<style>
    .card-3d {
        border: none;
        border-radius: 1.2rem;
        box-shadow: 0 10px 24px rgba(0,0,0,.12);
        background: linear-gradient(135deg,#e0f2fe 0%,#f8fafc 100%);
        max-width: 520px;
        margin: 30px auto;
        overflow: hidden;
    }

    .header {
        background: linear-gradient(90deg,#2563eb 60%,#38bdf8 100%);
        color: #fff;
        padding: 16px 20px;
    }

    .pw-meter {
        height: 8px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
    }

        .pw-meter > div {
            height: 100%;
            width: 0%;
            transition: width .25s ease;
        }

    .pw-weak {
        background: #ef4444;
    }

    .pw-fair {
        background: #f59e0b;
    }

    .pw-good {
        background: #10b981;
    }

    .pw-strong {
        background: #22c55e;
    }

    .form-note {
        font-size: .9rem;
        color: #64748b;
    }

    .btn-glass {
        background: rgba(59,130,246,0.12);
        border: 1px solid #93c5fd;
        color: #2563eb;
        border-radius: 999px;
        font-weight: 600;
        transition: all .2s;
    }

        .btn-glass:hover {
            background: #60a5fa;
            color: #fff;
            border-color: #2563eb;
        }
</style>

<div class="card-3d">
    <div class="header">
        <h5 class="m-0">
            <i class="fa-solid fa-key"></i> Reset Password — @memberName
        </h5>
    </div>

    <div class="p-4">
        <form asp-action="ResetPassword" asp-controller="Members" method="post" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model" />
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

            <div class="alert alert-info py-2">
                <div class="d-flex align-items-center gap-2">
                    <i class="fa-regular fa-lightbulb"></i>
                    <div>
                        Password length 5–20, suggest at least 8+ with letters, numbers, and symbols.
                    </div>
                </div>
            </div>

            <!-- New Password -->
            <div class="mb-3">
                <label class="form-label">New Password</label>
                <div class="input-group">
                    <input id="NewPassword" name="NewPassword" type="password" class="form-control rounded-start-pill" required minlength="5" maxlength="20" />
                    <button class="btn btn-outline-secondary rounded-end-pill" type="button" onclick="togglePw('NewPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </div>
                <div class="pw-meter mt-2" aria-hidden="true">
                    <div id="pwBar" class="pw-weak"></div>
                </div>
                <div id="pwHint" class="form-note mt-1">Strength: —</div>
            </div>

            <!-- Confirm -->
            <div class="mb-3">
                <label class="form-label">Confirm New Password</label>
                <div class="input-group">
                    <input id="ConfirmPassword" name="ConfirmPassword" type="password" class="form-control rounded-start-pill" required minlength="5" maxlength="20" />
                    <button class="btn btn-outline-secondary rounded-end-pill" type="button" onclick="togglePw('ConfirmPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </div>
                <div id="matchMsg" class="mt-1"></div>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button id="submitBtn" type="submit" class="btn btn-primary rounded-pill px-4">
                    <i class="fa-solid fa-rotate"></i> Reset Password
                </button>
                <a asp-action="Details" asp-route-id="@Model" class="btn btn-glass px-4">
                    <i class="fa-solid fa-arrow-left"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function togglePw(id, btn) {
            const input = document.getElementById(id);
            if (!input) return;
            const isPw = input.type === "password";
            input.type = isPw ? "text" : "password";
            btn.innerHTML = isPw ? '<i class="fa-regular fa-eye-slash"></i>' : '<i class="fa-regular fa-eye"></i>';
        }

        const newPw = document.getElementById('NewPassword');
        const confPw = document.getElementById('ConfirmPassword');
        const bar = document.getElementById('pwBar');
        const hint = document.getElementById('pwHint');
        const matchMsg = document.getElementById('matchMsg');
        const submitBtn = document.getElementById('submitBtn');

        function pwScore(pw) {
            let s = 0;
            if (!pw) return 0;
            if (pw.length >= 5) s++;
            if (pw.length >= 8) s++;
            if (/[A-Z]/.test(pw)) s++;
            if (/[a-z]/.test(pw)) s++;
            if (/[0-9]/.test(pw)) s++;
            if (/[^A-Za-z0-9]/.test(pw)) s++;
            return Math.min(s, 5); // cap
        }

        function updateStrength() {
            const pw = newPw.value || "";
            const score = pwScore(pw);
            let width = "0%", cls = "pw-weak", label = "—";
            if (score <= 1) { width = "20%"; cls = "pw-weak"; label = "Weak"; }
            else if (score == 2) { width = "40%"; cls = "pw-weak"; label = "Weak"; }
            else if (score == 3) { width = "60%"; cls = "pw-fair"; label = "Fair"; }
            else if (score == 4) { width = "80%"; cls = "pw-good"; label = "Good"; }
            else if (score >= 5) { width = "100%"; cls = "pw-strong"; label = "Strong"; }

            bar.className = cls;
            bar.style.width = width;
            hint.textContent = "Strength: " + label;
        }

        function validateMatch() {
            const a = newPw.value, b = confPw.value;
            if (!b) {
                matchMsg.textContent = "";
                return;
            }
            if (a === b) {
                matchMsg.className = "text-success";
                matchMsg.innerHTML = '<i class="fa-solid fa-check-circle"></i> Passwords match';
            } else {
                matchMsg.className = "text-danger";
                matchMsg.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Passwords do not match';
            }
        }

        function validateFormState() {
            const a = newPw.value, b = confPw.value;
            const lenOk = a.length >= 5 && a.length <= 20;
            const matchOk = a && b && a === b;
            submitBtn.disabled = !(lenOk && matchOk);
        }

        ['input', 'keyup', 'change'].forEach(evt => {
            newPw.addEventListener(evt, () => { updateStrength(); validateMatch(); validateFormState(); });
            confPw.addEventListener(evt, () => { validateMatch(); validateFormState(); });
        });

        // init
        updateStrength();
        validateFormState();
    </script>
}
