@model LibrarySystemBBU.Models.BookBorrow
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Text.Json

@{
    ViewData["Title"] = "Edit Loan";

    // Build catalog options string (like Create)
    var catalogItems = (IEnumerable<SelectListItem>)(ViewBag.CatalogId ?? Enumerable.Empty<SelectListItem>());
    string CATALOG_OPTIONS = string.Join("", catalogItems.Select(o => $"<option value='{o.Value}'>{o.Text}</option>"));

    // Books grouped by catalog, from controller: ViewBag.BooksByCatalog = new { BookId, CatalogId, Text }
    var booksByCatalogRaw = ViewBag.BooksByCatalog ?? new List<object>();
    string BOOKS_BY_CATALOG_JSON = JsonSerializer.Serialize(booksByCatalogRaw);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* ========= Page-specific tweaks (reusing global glass theme) ========= */

    /* Just spacing for toolbar on this page */
    #loanEditPage .toolbar {
        margin-bottom: 12px;
    }

    /* Use global .card-glass.glas-all-style; just header/body padding like Create */
    #loanEditForm .card-glass.glas-all-style .card-header {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(1,0,140,.12);
        font-weight: 700;
        color: var(--brand-700, #00007a);
        background: linear-gradient(180deg,var(--brand-50, #eef0ff),rgba(255,255,255,.8));
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
    }

    #loanEditForm .card-glass.glas-all-style .card-body {
        padding: 16px;
    }

    /* Items table wrapper */
    #loanEditForm .card-glass.glas-all-style .table-wrap {
        overflow: auto;
        border: 1px solid rgba(1,0,140,.12);
        border-radius: 12px;
        background: rgba(255,255,255,.85);
    }

    /* Section hint */
    #loanEditForm .card-glass.glas-all-style .hint {
        font-size: .85rem;
        color: var(--muted);
    }

    /* ===== Select2 styling, scoped to this page ===== */

    #loanEditForm .select2-container {
        width: min-content;
        font-size: 0.9rem;
    }

    #loanEditForm .select2-container--default .select2-selection--single {
        border-radius: 0.375rem;
        border: 1px solid rgba(1,0,140,.20);
        height: calc(2.35rem + 2px);
        background: linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.8));
        box-shadow: 0 1px 2px rgba(15,23,42,.08);
        display: flex;
        align-items: center;
        padding: 0 .75rem;
    }

        #loanEditForm .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding-left: 0;
            padding-right: 1.5rem;
            color: var(--text);
           font-size: 17px;
        }

        #loanEditForm .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: var(--muted);
        }

        #loanEditForm .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100%;
            right: .6rem;
        }

            #loanEditForm .select2-container--default .select2-selection--single .select2-selection__arrow b {
                border-color: var(--muted) transparent transparent transparent;
            }

    #loanEditForm .select2-container--default.select2-container--open .select2-selection--single,
    #loanEditForm .select2-container--default.select2-container--focus .select2-selection--single {
        outline: none;
        border-color: var(--brand-400, #7f87ff);
        box-shadow: 0 0 0 3px rgba(61,61,255,.25);
    }

    #loanEditForm .select2-container .select2-dropdown {
        border-radius: 0.5rem;
        border: 1px solid rgba(15,23,42,.12);
        box-shadow: 0 16px 30px rgba(15,23,42,.20);
    }

    #loanEditForm .select2-results__option {
        padding: 6px 10px;
        font-size: 0.9rem;
    }

    #loanEditForm .select2-results__option--highlighted[aria-selected] {
        background-color: var(--brand-400, #7f87ff);
    }

    /* Slightly more compact inside table rows */
    #loanEditForm #detailsTable .select2-container--default .select2-selection--single {
        height: calc(2.0rem + 2px);
        font-size: 0.85rem;
        padding: 0 .5rem;
    }

        #loanEditForm #detailsTable .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding-right: 1.2rem;
        }
</style>

<div id="loanEditPage">
    <h2 class="page-title">
        <span class="logo-dot"></span>
        Edit Book Borrow
    </h2>

    <div class="toolbar d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="hint">
            <i class="bi bi-info-circle"></i>
            Update borrow header &amp; items below. Use <b>Add Item</b> to append more rows.
        </div>
        <div class="btn-wrap d-flex gap-2">
            <a asp-action="Index" class="btn-glass">
                <i class="bi bi-arrow-left-circle"></i> Back to List
            </a>
        </div>
    </div>

    <form asp-action="Edit" method="post" novalidate id="loanEditForm">
        <input type="hidden" asp-for="LoanId" />
        <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

        <!-- HEADER CARD -->
        <div class="card-glass glas-all-style">
            <div class="card-header">
                <i class="bi bi-clipboard2-plus"></i> Borrow information
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label asp-for="MemberId" class="form-label">
                            <i class="bi bi-person-badge"></i> Member
                        </label>
                        <select asp-for="MemberId" class="form-select" asp-items="ViewBag.MemberId"></select>
                        <span asp-validation-for="MemberId" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="LoanDate" class="form-label">
                            <i class="bi bi-calendar-date"></i> Borrow Date
                        </label>
                        <input asp-for="LoanDate" type="date" class="form-control" />
                        <span asp-validation-for="LoanDate" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="DueDate" class="form-label">
                            <i class="bi bi-calendar2-event"></i> Due Date
                        </label>
                        <input asp-for="DueDate" type="date" class="form-control" />
                        <span asp-validation-for="DueDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="BorrowingFee" class="form-label">
                            <i class="bi bi-cash-coin"></i> Borrowing Fee
                        </label>
                        <input asp-for="BorrowingFee" class="form-control" />
                        <span asp-validation-for="BorrowingFee" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="DepositAmount" class="form-label">
                            <i class="bi bi-piggy-bank"></i> Deposit
                        </label>
                        <input asp-for="DepositAmount" class="form-control" />
                        <span asp-validation-for="DepositAmount" class="text-danger"></span>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <div class="form-check">
                            <input asp-for="IsPaid" class="form-check-input" id="chkPaid" />
                            <label asp-for="IsPaid" class="form-check-label">
                                <i class="bi bi-receipt"></i> Paid
                            </label>
                        </div>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <div class="form-check">
                            <input asp-for="IsReturned" class="form-check-input" id="chkReturned" />
                            <label asp-for="IsReturned" class="form-check-label">
                                <i class="bi bi-flag"></i> Is Returned
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ITEMS CARD -->
        <div class="card-glass glas-all-style mt-3">
            <div class="card-header">
                <i class="bi bi-journal-bookmark"></i> Borrow Items
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-3">
                        <div class="section-title">
                            <i class="bi bi-collection"></i> Items
                        </div>
                        <span class="hint">
                            Change <b>Catalog</b> and the <b>Book (Barcode)</b> will auto-update like on Create.
                        </span>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn-glass" onclick="addDetailRow()">
                            <i class="bi bi-plus-circle"></i> Add Item
                        </button>
                    </div>
                </div>

                <div class="table-wrap mb-2">
                    <table class="table table-sm align-middle mb-0" id="detailsTable">
                        <thead>
                            <tr>
                                <th style="min-width:180px;">Book (Barcode)</th>
                                <th style="min-width:200px;">Catalog</th>
                                <th style="min-width:160px;">Condition Out</th>
                                <th style="min-width:160px;">Condition In</th>
                                <th style="min-width:120px;">Fine</th>
                                <th style="min-width:220px;">Reason</th>
                                <th style="width:60px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var i = 0;
                                var bookItems = (IEnumerable<SelectListItem>)ViewBag.BookId ?? Enumerable.Empty<SelectListItem>();
                                var catItems = (IEnumerable<SelectListItem>)ViewBag.CatalogId ?? Enumerable.Empty<SelectListItem>();

                                foreach (var d in Model.LoanBookDetails)
                                {
                                    <tr>
                                        <td>
                                            <input type="hidden"
                                                   name="LoanBookDetails[@i].LoanBookDetailId"
                                                   value="@d.LoanBookDetailId" />
                                            <select name="LoanBookDetails[@i].BookId"
                                                    class="form-select">
                                                <option value="">-- Select Book --</option>
                                                @foreach (var o in bookItems)
                                                {
                                                    var selected = o.Value == d.BookId.ToString() ? "selected" : null;
                                                    <option value="@o.Value" selected="@selected">@o.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <select name="LoanBookDetails[@i].CatalogId"
                                                    class="form-select select2-catalog">
                                                <option value="">-- Select Catalog --</option>
                                                @foreach (var o in catItems)
                                                {
                                                    var selected = o.Value == d.CatalogId.ToString() ? "selected" : null;
                                                    <option value="@o.Value" selected="@selected">@o.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <input name="LoanBookDetails[@i].ConditionOut"
                                                   class="form-control"
                                                   value="@d.ConditionOut" />
                                        </td>
                                        <td>
                                            <input name="LoanBookDetails[@i].ConditionIn"
                                                   class="form-control"
                                                   value="@d.ConditionIn" />
                                        </td>
                                        <td>
                                            <input name="LoanBookDetails[@i].FineDetailAmount"
                                                   class="form-control"
                                                   type="number"
                                                   step="0.01"
                                                   value="@(d.FineDetailAmount?.ToString() ?? "")" />
                                        </td>
                                        <td>
                                            <input name="LoanBookDetails[@i].FineDetailReason"
                                                   class="form-control"
                                                   value="@d.FineDetailReason" />
                                        </td>
                                        <td class="text-nowrap">
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger"
                                                    title="Remove row"
                                                    onclick="this.closest('tr').remove()">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    i++;
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <hr />
                <div class="d-flex flex-wrap gap-2">
                    <button type="submit" class="btn-glass btn-brand">
                        <i class="bi bi-save2"></i> Save Changes
                    </button>
                    <a asp-action="Index" class="btn-glass">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                    <a asp-action="Details" asp-route-id="@Model.LoanId" class="btn-glass">
                        <i class="bi bi-eye"></i> View Details
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // ===== Server data (same concept as Create) =====
        let detailIndex = @(Model.LoanBookDetails?.Count() ?? 0);
        const CATALOG_OPTIONS = `@Html.Raw(CATALOG_OPTIONS)`;
        const BOOKS_BY_CATALOG = @Html.Raw(BOOKS_BY_CATALOG_JSON); // [{BookId,CatalogId,Text}]

        console.log("BOOKS_BY_CATALOG (Edit):", BOOKS_BY_CATALOG);

        // Build map: catalogId -> [{value,text}]
        const mapBooks = {};
        (BOOKS_BY_CATALOG || []).forEach(b => {
            const cid = (b.catalogId ?? b.CatalogId);
            const bid = (b.bookId ?? b.BookId);
            const txt = (b.text ?? b.Text);

            if (!cid || !bid) return;

            const key = String(cid);
            if (!mapBooks[key]) mapBooks[key] = [];
            mapBooks[key].push({ value: String(bid), text: txt });
        });

        console.log("mapBooks (Edit, catalog -> books):", mapBooks);

        // ===== Helpers =====
        function setBookOptionsForCatalog(selBook, catalogId, keepCurrent) {
            const key = String(catalogId);
            const list = mapBooks[key] || [];
            const oldValue = selBook.value;

            selBook.innerHTML = `<option value="">-- Select Book --</option>`;

            list.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                selBook.appendChild(opt);
            });

            if (list.length === 0) {
                selBook.disabled = true;
                selBook.value = "";
                return;
            }

            selBook.disabled = false;

            if (keepCurrent && oldValue && list.some(x => x.value === String(oldValue))) {
                selBook.value = oldValue;
                console.log("Preserved BookId on init:", oldValue);
            } else {
                selBook.value = list[0].value;
                console.log("Auto-selected first BookId:", list[0].value);
            }
        }

        function hookRowEvents(row, isInitial) {
            const selCatalog = row.querySelector("select[name$='.CatalogId']");
            const selBook = row.querySelector("select[name$='.BookId']");

            if (!selCatalog || !selBook) return;

            // On initial attach, align Book dropdown with existing Catalog
            if (isInitial && selCatalog.value) {
                setBookOptionsForCatalog(selBook, selCatalog.value, true);
            }

            const handler = function () {
                const cid = selCatalog.value;
                console.log("Catalog changed in Edit:", cid);

                if (!cid) {
                    selBook.innerHTML = `<option value="">-- Select Book --</option>`;
                    selBook.disabled = true;
                } else {
                    setBookOptionsForCatalog(selBook, cid, false); // change -> always auto pick first
                }
            };

            selCatalog.addEventListener('change', handler);

            // Also hook select2 change if active
            if (window.jQuery) {
                jQuery(selCatalog).on('change.select2', handler);
            }
        }

        function addDetailRow() {
            const tbody = document.querySelector("#detailsTable tbody");
            const tr = document.createElement("tr");

            tr.innerHTML = `
                        <td>
                            <input type="hidden"
                                   name="LoanBookDetails[${detailIndex}].LoanBookDetailId"
                                   value="0" />
                            <select name="LoanBookDetails[${detailIndex}].BookId"
                                    class="form-select" disabled>
                                <option value="">-- Select Book --</option>
                            </select>
                        </td>
                        <td>
                            <select name="LoanBookDetails[${detailIndex}].CatalogId"
                                    class="form-select select2-catalog">
                                <option value="">-- Select Catalog --</option>
                                ${CATALOG_OPTIONS}
                            </select>
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].ConditionOut"
                                   class="form-control"
                                   placeholder="e.g., Good"
                                   required />
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].ConditionIn"
                                   class="form-control"
                                   placeholder="Leave blank" />
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].FineDetailAmount"
                                   class="form-control"
                                   type="number"
                                   step="0.01" />
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].FineDetailReason"
                                   class="form-control"
                                   placeholder="optional" />
                        </td>
                        <td class="text-nowrap">
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    title="Remove row"
                                    onclick="this.closest('tr').remove()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </td>
                    `;

            tbody.appendChild(tr);

            // Apply select2 for new Catalog select
            if (window.jQuery && jQuery.fn.select2) {
                jQuery(tr).find('.select2-catalog').select2({ width: '100%' });
            }

            hookRowEvents(tr, false);
            detailIndex++;
        }

        // ===== Init =====
        jQuery(function ($) {
            console.log("Edit Borrow DOM ready");

            // Member select2
            if ($.fn.select2) {
                $('#MemberId').select2({
                    width: '100%',
                    placeholder: 'Search member...',
                    allowClear: true
                });

                // Catalog selects in existing rows
                $('#detailsTable tbody .select2-catalog').select2({
                    width: '100%'
                });
            }

            // Hook events for existing rows and align books with catalogs
            document.querySelectorAll("#detailsTable tbody tr").forEach(tr => {
                hookRowEvents(tr, true);
            });
        });
    </script>
}
