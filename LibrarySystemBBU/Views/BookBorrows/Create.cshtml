@model LibrarySystemBBU.Models.BookBorrow
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Text.Json

@{
    ViewData["Title"] = "Create Loan";
    var today = DateTime.Today.ToString("yyyy-MM-dd");
    var next7 = DateTime.Today.AddDays(7).ToString("yyyy-MM-dd");

    // safety defaults if ViewBag is missing
    var memberItems = (IEnumerable<SelectListItem>)(ViewBag.MemberId ?? Enumerable.Empty<SelectListItem>());
    var bookItems = (IEnumerable<SelectListItem>)(ViewBag.BookId ?? Enumerable.Empty<SelectListItem>());
    var catalogItems = (IEnumerable<SelectListItem>)(ViewBag.CatalogId ?? Enumerable.Empty<SelectListItem>());

    // only need catalog options for skeleton
    string CATALOG_OPTIONS = string.Join("", catalogItems.Select(o => $"<option value='{o.Value}'>{o.Text}</option>"));

    // books grouped by catalog for client-side binding
    // from controller: ViewBag.BooksByCatalog = new { BookId, CatalogId, Text }
    var booksByCatalogRaw = ViewBag.BooksByCatalog ?? new List<object>();
    string BOOKS_BY_CATALOG_JSON = JsonSerializer.Serialize(booksByCatalogRaw);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* ========= Page-specific tweaks (reusing global glass theme) ========= */

    #loanForm.card-glass.glas-all-style {
    }

        #loanForm .card-glass.glas-all-style .card-header {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(1,0,140,.12);
            font-weight: 700;
            color: var(--brand-700, #00007a);
            background: linear-gradient(180deg,var(--brand-50, #eef0ff),rgba(255,255,255,.8));
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        #loanForm .card-glass.glas-all-style .card-body {
            padding: 16px;
        }

        #loanForm .card-glass.glas-all-style #detailsWrap {
            overflow: auto;
            border: 1px solid rgba(1,0,140,.12);
            border-radius: 12px;
            background: rgba(255,255,255,.85);
            overflow: hidden;
        }

        #loanForm .card-glass.glas-all-style .summary {
            display: grid;
            grid-template-columns: repeat(4, minmax(130px, 1fr));
            gap: 10px;
        }

            #loanForm .card-glass.glas-all-style .summary .pill {
                align-items: flex-start;
            }

                #loanForm .card-glass.glas-all-style .summary .pill .k {
                    font-size: .78rem;
                    color: var(--muted);
                }

                #loanForm .card-glass.glas-all-style .summary .pill .v {
                    font-weight: 800;
                    letter-spacing: .3px;
                }

        #loanForm .card-glass.glas-all-style .hint {
            font-size: .85rem;
            color: var(--muted);
        }

        #loanForm .card-glass.glas-all-style .btn-dangerish {
            background: linear-gradient(180deg,#ff9aa0,#ff6b75);
            color: #fff;
            border-color: rgba(255,255,255,.5);
        }

        /* ===== Select2 styling, scoped to this page only ===== */

        #loanForm .card-glass.glas-all-style .select2-container {
            width: min-content;
            font-size: 0.9rem;
        }

        #loanForm .card-glass.glas-all-style .select2-container--default .select2-selection--single {
            border-radius: 0.375rem;
            border: 1px solid rgba(1,0,140,.20);
            height: calc(2.35rem + 2px);
            background: linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.8));
            box-shadow: 0 1px 2px rgba(15,23,42,.08);
            display: flex;
            align-items: center;
            padding: 0 .75rem;
        }

            #loanForm .card-glass.glas-all-style .select2-container--default .select2-selection--single .select2-selection__rendered {
                padding-left: 0;
                padding-right: 1.5rem;
                color: var(--text);
                font-size: 17px;
            }

            #loanForm .card-glass.glas-all-style .select2-container--default .select2-selection--single .select2-selection__placeholder {
                color: var(--muted);
            }

            #loanForm .card-glass.glas-all-style .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 100%;
                right: .6rem;
            }

                #loanForm .card-glass.glas-all-style .select2-container--default .select2-selection--single .select2-selection__arrow b {
                    border-color: var(--muted) transparent transparent transparent;
                }

        #loanForm .card-glass.glas-all-style .select2-container--default.select2-container--open .select2-selection--single,
        #loanForm .card-glass.glas-all-style .select2-container--default.select2-container--focus .select2-selection--single {
            outline: none;
            border-color: var(--brand-400, #7f87ff);
            box-shadow: 0 0 0 3px rgba(61,61,255,.25);
        }

        #loanForm .card-glass.glas-all-style .select2-container .select2-dropdown {
            border-radius: 0.5rem;
            border: 1px solid rgba(15,23,42,.12);
            box-shadow: 0 16px 30px rgba(15,23,42,.20);
        }

        #loanForm .card-glass.glas-all-style .select2-results__option {
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        #loanForm .card-glass.glas-all-style .select2-results__option--highlighted[aria-selected] {
            background-color: var(--brand-400, #7f87ff);
        }

        #loanForm .card-glass.glas-all-style #detailsTable .select2-container--default .select2-selection--single {
            height: calc(2.0rem + 2px);
            font-size: 0.85rem;
            padding: 0 .5rem;
        }

            #loanForm .card-glass.glas-all-style #detailsTable .select2-container--default .select2-selection--single .select2-selection__rendered {
                padding-right: 1.2rem;
            }
</style>

<h2 class="page-title">
    <span class="logo-dot"></span>
    Create Borrow
</h2>

<form asp-action="Create" method="post" id="loanForm">
    @Html.AntiForgeryToken()
    <div class="card-glass glas-all-style">
        <div class="card-header">
            <i class="bi bi-clipboard2-plus"></i> Borrow information
        </div>

        <div class="card-body">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="MemberId" class="form-label">Member</label>
                    <select asp-for="MemberId" class="form-select select2-member" asp-items="memberItems">
                        <option value="">-- Select Member --</option>
                    </select>
                    <span asp-validation-for="MemberId" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="LoanDate" class="form-label">Borrow Date</label>
                    <!-- ✅ allow ANY date -->
                    <input asp-for="LoanDate"
                           type="date"
                           class="form-control"
                           value="@(Model.LoanDate == default ? today : Model.LoanDate.ToString("yyyy-MM-dd"))" />
                    <span asp-validation-for="LoanDate" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="DueDate" class="form-label">Due Date</label>
                    <!-- ✅ allow ANY date -->
                    <input asp-for="DueDate"
                           type="date"
                           class="form-control"
                           value="@(Model.DueDate == default ? next7 : Model.DueDate.ToString("yyyy-MM-dd"))" />
                    <span asp-validation-for="DueDate" class="text-danger"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="BorrowingFee" class="form-label">Borrowing Fee</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-cash-coin"></i></span>
                        <input asp-for="BorrowingFee" class="form-control" value="0.00" />
                    </div>
                    <span asp-validation-for="BorrowingFee" class="text-danger"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="DepositAmount" class="form-label">Deposit</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-piggy-bank"></i></span>
                        <input asp-for="DepositAmount" class="form-control" />
                    </div>
                    <span asp-validation-for="DepositAmount" class="text-danger"></span>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check">
                        <input asp-for="IsPaid" class="form-check-input" id="chkPaid" />
                        <label asp-for="IsPaid" class="form-check-label">Is Paid</label>
                    </div>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check">
                        <input asp-for="IsReturned" class="form-check-input" id="chkReturned" />
                        <label asp-for="IsReturned" class="form-check-label">Is Returned</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-glass glas-all-style mt-3">
        <div class="card-header ">
            <i class="bi bi-journal-bookmark"></i> Borrow Items
        </div>

        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-3">
                    <div class="section-title">
                        <i class="bi bi-collection"></i> Items
                    </div>
                    <span class="hint">
                        ជ្រើស <b>Catalog</b> ➜ <b>Book (Barcode)</b> នឹងត្រូវជ្រើសអូតូ
                    </span>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn-glass btn-outline" id="btnAddItem">
                        <i class="bi bi-plus-circle"></i> Add Item
                    </button>
                    <button type="button" class="btn-glass btn-dangerish" id="btnClearAll">
                        <i class="bi bi-trash3"></i> Clear All
                    </button>
                </div>
            </div>

            <div id="detailsWrap">
                <table class="table table-hover mb-0" id="detailsTable">
                    <thead>
                        <tr>
                            <th style="min-width:200px;">Book (Barcode)</th>
                            <th style="min-width:220px;">Catalog (Title — ISBN)</th>
                            <th style="min-width:160px;">Condition Out</th>
                            <th style="min-width:160px;">Condition In</th>
                            <th style="min-width:120px;">Fine</th>
                            <th style="min-width:220px;">Reason</th>
                            <th style="width:60px;"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="mt-3 summary">
                <div class="pill">
                    <div class="k"><i class="bi bi-list-ol"></i> Items</div>
                    <div class="v" id="sumItems">0</div>
                </div>
                <div class="pill">
                    <div class="k"><i class="bi bi-coin"></i> Fine Total</div>
                    <div class="v" id="sumFine">0.00</div>
                </div>
                <div class="pill">
                    <div class="k"><i class="bi bi-cash-coin"></i> Fee + Fine</div>
                    <div class="v" id="sumFeeFine">0.00</div>
                </div>
                <div class="pill">
                    <div class="k"><i class="bi bi-safe"></i> Deposit Amount</div>
                    <div class="v" id="sumDeposit">0.00</div>
                </div>
            </div>
        </div>

        <div class="card-body d-flex gap-2 justify-content-end">
            <a asp-action="Index" class="btn-glass btn-outline">
                <i class="bi bi-arrow-left"></i> Cancel
            </a>
            <button type="button" class="btn-glass btn-brand" id="btnSave">
                <i class="bi bi-check2-circle"></i> Save
            </button>
        </div>

    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // ===== Server data =====
        let detailIndex = 0;
        const CATALOG_OPTIONS = `@Html.Raw(CATALOG_OPTIONS)`;
        const BOOKS_BY_CATALOG = @Html.Raw(BOOKS_BY_CATALOG_JSON); // [{BookId,CatalogId,Text}]

        console.log("BOOKS_BY_CATALOG from server:", BOOKS_BY_CATALOG);

        // Build map: catalogId -> [{value,text}]
        const mapBooks = {};
        (BOOKS_BY_CATALOG || []).forEach(b => {
            const cid = (b.catalogId ?? b.CatalogId);
            const bid = (b.bookId ?? b.BookId);
            const txt = (b.text ?? b.Text);

            if (!cid || !bid) return;

            const key = String(cid);
            if (!mapBooks[key]) mapBooks[key] = [];
            mapBooks[key].push({ value: String(bid), text: txt });
        });

        console.log("mapBooks (catalog -> books):", mapBooks);

        // ===== Helpers =====
        const $qs = s => document.querySelector(s);
        const $qsa = s => Array.from(document.querySelectorAll(s));
        const money = n => (isNaN(+n) ? '0.00' : (+n).toFixed(2));

        function recalcSummary() {
            const rows = $qsa("#detailsTable tbody tr");
            $qs('#sumItems').innerText = rows.length;

            let fine = 0;
            rows.forEach(r => {
                const v = parseFloat(r.querySelector("[name$='.FineDetailAmount']")?.value || '0');
                if (!isNaN(v)) fine += v;
            });
            const fee = parseFloat($qs('#BorrowingFee')?.value || '0');
            const dep = parseFloat($qs('#DepositAmount')?.value || '0');
            $qs('#sumFine').innerText = money(fine);
            $qs('#sumFeeFine').innerText = money((isNaN(fee) ? 0 : fee) + fine);
            $qs('#sumDeposit').innerText = money(isNaN(dep) ? 0 : dep);
        }

        function setBookOptionsForCatalog(bookSelect, catalogId) {
            const key = String(catalogId);
            const list = mapBooks[key] || [];

            bookSelect.innerHTML = `<option value="">-- Select Book --</option>`;

            list.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                bookSelect.appendChild(opt);
            });

            if (list.length === 0) {
                bookSelect.disabled = true;
                bookSelect.value = "";
                return;
            }

            bookSelect.disabled = false;

            // Auto-select first book
            bookSelect.value = list[0].value;
        }

        function hookRowEvents(row) {
            row.querySelectorAll("input,select").forEach(el =>
                el.addEventListener('input', recalcSummary)
            );

            const selCatalog = row.querySelector("select[name$='.CatalogId']");
            const selBook = row.querySelector("select[name$='.BookId']");

            selBook.disabled = true;

            const handler = function () {
                const cid = selCatalog.value;

                if (!cid) {
                    selBook.innerHTML = `<option value="">-- Select Book --</option>`;
                    selBook.disabled = true;
                } else {
                    const dup = $qsa("select[name$='.CatalogId']")
                        .filter(x => x !== selCatalog && x.value === cid);

                    if (dup.length) {
                        Swal.fire({
                            title: 'Duplicate Catalog',
                            text: 'This Catalog has already been selected.',
                            icon: 'warning',
                            confirmButtonColor: '#01008C'
                        });
                        selCatalog.value = "";
                        selBook.innerHTML = `<option value="">-- Select Book --</option>`;
                        selBook.disabled = true;
                    } else {
                        setBookOptionsForCatalog(selBook, cid);
                    }
                }
                recalcSummary();
            };

            selCatalog.addEventListener('change', handler);

            if (window.jQuery) {
                jQuery(selCatalog).on('change.select2', handler);
            }

            row.querySelector(".btn-remove").addEventListener("click", () => {
                row.remove();
                recalcSummary();
            });
        }

        function initCatalogSelect2(scope) {
            if (!window.jQuery || !jQuery.fn.select2) return;
            jQuery(scope).find('.select2-catalog').select2({
                placeholder: '-- Select Catalog --',
                width: '100%',
                dropdownAutoWidth: true
            });
        }

        function addDetailRow() {
            const tr = document.createElement("tr");
            tr.className = "detail-row";
            tr.innerHTML = `
                        <td>
                            <select name="LoanBookDetails[${detailIndex}].BookId" class="form-select" disabled>
                                <option value="">-- Select Book --</option>
                            </select>
                        </td>
                        <td>
                            <select name="LoanBookDetails[${detailIndex}].CatalogId" class="form-select select2-catalog" required>
                                <option value="">-- Select Catalog --</option>
                                ${CATALOG_OPTIONS}
                            </select>
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].ConditionOut"
                                   class="form-control"
                                   placeholder="e.g., Good"
                                   required />
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].ConditionIn"
                                   class="form-control"
                                   placeholder="Leave blank for now" />
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].FineDetailAmount"
                                   class="form-control"
                                   type="number"
                                   step="0.01"
                                   value="0"
                                   min="0" />
                        </td>
                        <td>
                            <input name="LoanBookDetails[${detailIndex}].FineDetailReason"
                                   class="form-control"
                                   placeholder="optional" />
                        </td>
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger btn-remove">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </td>
                    `;
            $qs("#detailsTable tbody").appendChild(tr);
            hookRowEvents(tr);
            detailIndex++;
            recalcSummary();

            initCatalogSelect2(tr);
        }

        document.addEventListener('DOMContentLoaded', function () {
            $qs("#btnAddItem").addEventListener("click", addDetailRow);

            $qs("#btnClearAll").addEventListener("click", () => {
                Swal.fire({
                    title: 'Clear all items?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Clear',
                    confirmButtonColor: '#ff6b75'
                }).then(res => {
                    if (res.isConfirmed) {
                        $qs("#detailsTable tbody").innerHTML = "";
                        recalcSummary();
                    }
                });
            });

            $qs("#BorrowingFee")?.addEventListener('input', recalcSummary);
            $qs("#DepositAmount")?.addEventListener('input', recalcSummary);

            const chkRet = $qs("#chkReturned");
            if (chkRet) {
                chkRet.checked = false;
                chkRet.addEventListener('change', () => {
                    chkRet.checked = false;
                    Swal.fire({
                        title: 'Not allowed on create',
                        text: 'Please use Return action after creating the Borrow.',
                        icon: 'info',
                        confirmButtonColor: '#01008C'
                    });
                });
            }

            addDetailRow();

            if (window.jQuery && jQuery.fn.select2) {
                jQuery('.select2-member').select2({
                    placeholder: '-- Select Member --',
                    allowClear: true,
                    width: '100%'
                });
            }

            $qs("#btnSave").addEventListener("click", (e) => {
                e.preventDefault();

                const member = $qs("#MemberId")?.value;
                const loanDt = $qs("#LoanDate")?.value;
                const dueDt = $qs("#DueDate")?.value;
                const rows = $qsa("#detailsTable tbody tr");

                if (!member || !loanDt || !dueDt) {
                    return Swal.fire({
                        title: 'Missing fields',
                        text: 'Please fill Member, Loan Date and Due Date.',
                        icon: 'warning',
                        confirmButtonColor: '#01008C'
                    });
                }
                if (rows.length === 0) {
                    return Swal.fire({
                        title: 'No items',
                        text: 'Please add at least one borrow item.',
                        icon: 'warning',
                        confirmButtonColor: '#01008C'
                    });
                }

                const invalid = rows.some(r => {
                    const b = r.querySelector("select[name$='.BookId']").value;
                    const c = r.querySelector("select[name$='.CatalogId']").value;
                    return !b || !c;
                });
                if (invalid) {
                    return Swal.fire({
                        title: 'Incomplete',
                        text: 'Please choose a Catalog for each row so Book (Barcode) can be auto-selected.',
                        icon: 'warning',
                        confirmButtonColor: '#01008C'
                    });
                }

                $qsa("#detailsTable select[name$='.BookId']").forEach(s => {
                    if (s.disabled && s.value) s.disabled = false;
                });

                Swal.fire({
                    title: 'Create Loan?',
                    html: `<div style="text-align:left;line-height:1.9;">
                                    <div><b>Items:</b> ${$qs('#sumItems').innerText}</div>
                                    <div><b>Fine Total:</b> ${$qs('#sumFine').innerText}</div>
                                    <div><b>Fee+Fine:</b> ${$qs('#sumFeeFine').innerText}</div>
                                    <div><b>Deposit Amount:</b> ${$qs('#sumDeposit').innerText}</div>
                                   </div>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Save',
                    confirmButtonColor: '#01008C'
                }).then(res => {
                    if (res.isConfirmed) $qs("#loanForm").submit();
                });
            });
        });
    </script>
}
