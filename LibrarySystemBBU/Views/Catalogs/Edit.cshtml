@model LibrarySystemBBU.Controllers.CatalogsController.CatalogFormVM
@{
    ViewData["Title"] = "Edit Catalog";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<h2 class="page-title">
    <span class="logo-dot"></span> Edit Catalog
</h2>

<div class="toolbar">
    <a asp-action="Index" class="btn-glass btn-outline">
        <i class="bi bi-arrow-left-circle"></i> Back
    </a>

    <span class="pill">
        <i class="bi bi-collection"></i>
        Total Copies: <strong id="statTotal">@Model.TotalCopies</strong>
    </span>

    <span class="pill">
        <i class="bi bi-box-seam"></i>
        Available: <strong id="statAvail">@Model.AvailableCopies</strong>
    </span>

    <span class="pill">
        <i class="bi bi-book"></i>
        Books: <strong>@(Model.Books?.Count ?? 0)</strong>
    </span>

    <button type="submit" form="catalogForm" class="btn-glass btn-brand ms-auto">
        <i class="bi bi-check2-circle"></i> Save
    </button>
</div>

<form id="catalogForm" asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input asp-for="CatalogId" type="hidden" />

    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <!-- ===== CARD 1: Catalog Info + Files ===== -->
    <div class="card-glass glas-all-style mt-3">
        <div class="section-title">
            <i class="bi bi-journal-text"></i> Catalog Info
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Title</label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="col-md-6">
                <label class="form-label">Author</label>
                <input asp-for="Author" class="form-control" />
                <span asp-validation-for="Author" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label class="form-label">ISBN</label>
                <input asp-for="ISBN" class="form-control" />
                <span asp-validation-for="ISBN" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label class="form-label">Category</label>
                <input asp-for="Category" class="form-control" />
                <span asp-validation-for="Category" class="text-danger"></span>
            </div>

            <div class="col-md-2">
                <label class="form-label">Total Copies</label>
                <input asp-for="TotalCopies"
                       class="form-control"
                       id="TotalCopies"
                       type="number"
                       min="0"
                       step="1"
                       readonly />
                <span asp-validation-for="TotalCopies" class="text-danger"></span>
            </div>

            <div class="col-md-2">
                <label class="form-label">Available</label>
                <input asp-for="AvailableCopies"
                       class="form-control"
                       id="AvailableCopies"
                       type="number"
                       min="0"
                       step="1"
                       readonly />
                <span asp-validation-for="AvailableCopies" class="text-danger"></span>
            </div>

            <!-- Image: current + replace (edit-only) -->
            <div class="col-md-6">
                <label class="form-label">Cover Image</label>
                <input asp-for="ImageFile" type="file" accept="image/*" class="form-control" id="ImageFile" />

                <div class="mt-2 d-flex align-items-center gap-2 flex-wrap">
                    @if (!string.IsNullOrWhiteSpace(Model.ImagePath))
                    {
                        <img src="@Model.ImagePath"
                             class="preview-img"
                             alt="current cover"
                             id="imgPreviewExisting" />

                        <a href="@Model.ImagePath"
                           target="_blank"
                           class="btn-glass btn-outline btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> Open current
                        </a>
                    }

                    <img id="imgPreviewNew" class="preview-img d-none" alt="new preview" />
                </div>

                <small class="text-muted">Upload to replace (jpg, jpeg, png, gif, webp)</small>
            </div>

            <!-- PDF: current + replace (edit-only) -->
            <div class="col-md-6">
                <label class="form-label">PDF File</label>
                <input asp-for="PdfFile" type="file" accept="application/pdf" class="form-control" id="PdfFile" />

                <div class="mt-2 d-flex align-items-center gap-2 flex-wrap">
                    @if (!string.IsNullOrWhiteSpace(Model.PdfFilePath))
                    {
                        <a href="@Model.PdfFilePath"
                           target="_blank"
                           class="btn-glass btn-outline btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> Open current PDF
                        </a>

                        <iframe class="embed-pdf" src="@Model.PdfFilePath"></iframe>
                    }

                    <span id="pdfNewName" class="pill file-pill d-none">
                        <i class="bi bi-filetype-pdf"></i> <span></span>
                    </span>
                </div>

                <small class="text-muted">Upload to replace (pdf)</small>
            </div>
        </div>
    </div>

    <!-- ===== CARD 2: Books ===== -->
    <div class="card-glass glas-all-style mt-3">
        <div class="section-title">
            <i class="bi bi-book"></i> Books
        </div>

        <div class="table-wrap">
            <table class="table table-sm table-bordered align-middle" id="booksTable">
                <thead>
                    <tr>
                        <th style="width:22%">Barcode</th>
                        <th style="width:22%">Status</th>
                        <th>Location</th>
                        <th style="width:22%">Acquisition Date</th>
                        <th style="width:8%"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < (Model.Books?.Count ?? 0); i++)
                    {
                        <tr>
                            <td>
                                <input asp-for="Books[i].BookId" type="hidden" />
                                <input asp-for="Books[i].CatalogId" type="hidden" />

                                <input asp-for="Books[i].Barcode" class="form-control" />
                                <span asp-validation-for="Books[i].Barcode" class="text-danger"></span>
                            </td>
                            <td>
                                <input asp-for="Books[i].Status" class="form-control" />
                                <span asp-validation-for="Books[i].Status" class="text-danger"></span>
                            </td>
                            <td>
                                <input asp-for="Books[i].Location" class="form-control" />
                            </td>
                            <td>
                                <input asp-for="Books[i].AcquisitionDate"
                                       type="date"
                                       class="form-control"
                                       value="@Model.Books[i].AcquisitionDate.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="Books[i].AcquisitionDate" class="text-danger"></span>
                            </td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="removeBookRow(this)">
                                    ✕
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Buttons under both cards -->
    <div class="d-flex gap-2 mt-2">
        <button type="button" class="btn-glass btn-outline" id="btnAddBook">
            <i class="bi bi-plus-circle"></i> Add Book
        </button>
        <button type="button" class="btn-glass btn-outline" id="btnAutoCount">
            <i class="bi bi-calculator"></i> Auto Count
        </button>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn-glass btn-brand">
            <i class="bi bi-check2-circle"></i> Save
        </button>
        <a asp-action="Index" class="btn-glass btn-outline">
            <i class="bi bi-arrow-left-circle"></i> Back
        </a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            // add/remove + auto count
            document.getElementById('btnAddBook')?.addEventListener('click', addBookRow);
            document.getElementById('btnAutoCount')?.addEventListener('click', autoCount);

            // image preview (NEW upload)
            const imgInput = document.getElementById('ImageFile');
            const imgPrevNew = document.getElementById('imgPreviewNew');
            imgInput?.addEventListener('change', e => {
                const f = e.target.files?.[0];
                if (!f) {
                    imgPrevNew.classList.add('d-none');
                    imgPrevNew.src = "";
                    return;
                }
                const url = URL.createObjectURL(f);
                imgPrevNew.src = url;
                imgPrevNew.classList.remove('d-none');
            });

            // pdf filename (NEW upload)
            const pdfInput = document.getElementById('PdfFile');
            const pdfNewName = document.getElementById('pdfNewName');
            pdfInput?.addEventListener('change', e => {
                const f = e.target.files?.[0];
                if (!f) {
                    pdfNewName.classList.add('d-none');
                    pdfNewName.querySelector('span').textContent = "";
                    return;
                }
                pdfNewName.querySelector('span').textContent = f.name;
                pdfNewName.classList.remove('d-none');
            });

            syncPills();
        })();

        function clampCopies() {
            const totalEl = document.getElementById('TotalCopies');
            const availEl = document.getElementById('AvailableCopies');
            if (!totalEl || !availEl) return;

            let total = parseInt(totalEl.value || '0');
            let avail = parseInt(availEl.value || '0');

            if (isNaN(total)) total = 0;
            if (isNaN(avail)) avail = 0;

            if (total < 0) total = 0;
            if (avail < 0) avail = 0;
            if (avail > total) avail = total;

            totalEl.value = total;
            availEl.value = avail;
        }

        function addBookRow() {
            const tbody = document.querySelector('#booksTable tbody');
            const idx = tbody.querySelectorAll('tr').length;
            const catalogId = document.querySelector('input[name=CatalogId]').value;
            const today = new Date().toISOString().slice(0, 10);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                                <td>
                                    <input name="Books[${idx}].BookId" value="0" type="hidden" />
                                    <input name="Books[${idx}].CatalogId" value="${catalogId}" type="hidden" />
                                    <input name="Books[${idx}].Barcode" class="form-control" />
                                </td>
                                <td>
                                    <input name="Books[${idx}].Status" class="form-control" value="Available" />
                                </td>
                                <td>
                                    <input name="Books[${idx}].Location" class="form-control" />
                                </td>
                                <td>
                                    <input name="Books[${idx}].AcquisitionDate" type="date" class="form-control" value="${today}" />
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBookRow(this)">✕</button>
                                </td>`;
            tbody.appendChild(tr);
            syncPills();
        }

        function removeBookRow(btn) {
            const tr = btn.closest('tr');
            tr.remove();

            const rows = document.querySelectorAll('#booksTable tbody tr');
            rows.forEach((row, i) => {
                row.querySelectorAll('input').forEach(inp => {
                    const name = inp.getAttribute('name');
                    if (name && name.startsWith('Books[')) {
                        const field = name.substring(name.indexOf('].') + 2);
                        inp.setAttribute('name', `Books[${i}].${field}`);
                    }
                });
            });

            syncPills();
        }

        function autoCount() {
            const rows = document.querySelectorAll('#booksTable tbody tr');
            const total = rows.length;
            let available = 0;

            rows.forEach(r => {
                const status = (r.querySelector('input[name*=".Status"]')?.value || '')
                    .trim()
                    .toLowerCase();
                if (status === 'available') {
                    available++;
                }
            });

            const totalEl = document.getElementById('TotalCopies');
            const availEl = document.getElementById('AvailableCopies');
            if (totalEl) totalEl.value = total;
            if (availEl) availEl.value = available;
            clampCopies();
            syncPills();
        }

        function syncPills() {
            const total = parseInt(document.getElementById('TotalCopies')?.value || '0');
            const avail = parseInt(document.getElementById('AvailableCopies')?.value || '0');
            document.getElementById('statTotal').textContent = isNaN(total) ? '0' : total.toString();
            document.getElementById('statAvail').textContent = isNaN(avail) ? '0' : avail.toString();
        }
    </script>
}
