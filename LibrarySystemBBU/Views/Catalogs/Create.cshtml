@model LibrarySystemBBU.Controllers.CatalogsController.CatalogFormVM
@{
    ViewData["Title"] = "Create Catalog";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<h2 class="page-title"><span class="logo-dot"></span> Create Catalog</h2>

<div class="toolbar">
    <a asp-action="Index" class="btn-glass btn-outline">
        <i class="bi bi-arrow-left-circle"></i> Back
    </a>

    <span class="pill">
        <i class="bi bi-collection"></i>
        Total Copies: <strong id="statTotal">@Model.TotalCopies</strong>
    </span>

    <span class="pill">
        <i class="bi bi-box-seam"></i>
        Available: <strong id="statAvail">@Model.AvailableCopies</strong>
    </span>

    <span class="hint ms-2">
        * ចុច “+ Add Book” ដើម្បីបន្ថែមជួរ
    </span>

    <button type="submit" form="catalogForm" class="btn-glass btn-brand ms-auto">
        <i class="bi bi-check2-circle"></i> Save
    </button>
</div>

<form id="catalogForm" asp-action="Create" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <div class="card-glass glas-all-style mt-3">
        <div class="section-title">
            <i class="bi bi-journal-text"></i> Catalog Info
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Title</label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="col-md-6">
                <label class="form-label">Author</label>
                <input asp-for="Author" class="form-control" />
                <span asp-validation-for="Author" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label class="form-label">ISBN</label>
                <input asp-for="ISBN" class="form-control" />
                <span asp-validation-for="ISBN" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label class="form-label">Category</label>
                <input asp-for="Category" class="form-control" />
                <span asp-validation-for="Category" class="text-danger"></span>
            </div>

            <div class="col-md-2">
                <label class="form-label">Total Copies</label>
                <input asp-for="TotalCopies"
                       class="form-control"
                       id="TotalCopies"
                       type="number"
                       min="0"
                       step="1"
                       readonly />
                <span asp-validation-for="TotalCopies" class="text-danger"></span>
            </div>

            <div class="col-md-2">
                <label class="form-label">Available</label>
                <input asp-for="AvailableCopies"
                       class="form-control"
                       id="AvailableCopies"
                       type="number"
                       min="0"
                       step="1"
                       readonly />
                <span asp-validation-for="AvailableCopies" class="text-danger"></span>
            </div>

            <!-- Image upload -->
            <div class="col-md-6">
                <label class="form-label">Cover Image</label>
                <input asp-for="ImageFile" type="file" accept="image/*" class="form-control" id="ImageFile" />
                <div class="mt-2 d-flex align-items-center gap-2">
                    <img id="imgPreview" class="preview-img d-none" />
                    <span id="imgName" class="pill file-pill d-none">
                        <i class="bi bi-image"></i> <span></span>
                    </span>
                </div>
                <small class="text-muted">Allowed: .jpg, .jpeg, .png, .gif, .webp</small>
            </div>

            <!-- PDF upload -->
            <div class="col-md-6">
                <label class="form-label">PDF File</label>
                <input asp-for="PdfFile" type="file" accept="application/pdf" class="form-control" id="PdfFile" />
                <div class="mt-2">
                    <span id="pdfName" class="pill file-pill d-none">
                        <i class="bi bi-filetype-pdf"></i> <span></span>
                    </span>
                </div>
                <small class="text-muted">Allowed: .pdf</small>
            </div>
        </div>
    </div>

    <div class="card-glass glas-all-style mt-3">
        <div class="section-title">
            <i class="bi bi-book"></i> Books
        </div>

        <div class="table-wrap">
            <table class="table table-sm table-bordered align-middle" id="booksTable">
                <thead>
                    <tr>
                        <th style="width:24%">Barcode</th>
                        <th style="width:22%">Status</th>
                        <th>Location</th>
                        <th style="width:22%">Acquisition Date</th>
                        <th style="width:8%"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < (Model.Books?.Count ?? 0); i++)
                    {
                        <tr>
                            <td>
                                <input asp-for="Books[@i].BookId" type="hidden" />
                                <input asp-for="Books[@i].CatalogId" type="hidden" />
                                <input asp-for="Books[@i].Barcode" class="form-control" />
                            </td>
                            <td>
                                <input asp-for="Books[@i].Status" class="form-control" />
                            </td>
                            <td>
                                <input asp-for="Books[@i].Location" class="form-control" />
                            </td>
                            <td>
                                <input asp-for="Books[@i].AcquisitionDate" type="date" class="form-control" />
                            </td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="removeBookRow(this)">
                                    ✕
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>


    <div class="d-flex gap-2 mt-2">
        <button type="button" class="btn-glass btn-outline" id="btnAddBook">
            <i class="bi bi-plus-circle"></i> Add Book
        </button>
        <button type="button" class="btn-glass btn-outline" id="btnAutoCount">
            <i class="bi bi-calculator"></i> Auto count totals
        </button>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn-glass btn-brand">
            <i class="bi bi-check2-circle"></i> Save
        </button>
        <a asp-action="Index" class="btn-glass btn-outline">
            <i class="bi bi-arrow-left-circle"></i> Back
        </a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            document.getElementById('btnAddBook')?.addEventListener('click', addBookRow);
            document.getElementById('btnAutoCount')?.addEventListener('click', autoCount);

            const imgInput = document.getElementById('ImageFile');
            const imgPrev = document.getElementById('imgPreview');
            const imgName = document.getElementById('imgName');
            imgInput?.addEventListener('change', e => {
                const f = e.target.files?.[0];
                if (!f) {
                    imgPrev.classList.add('d-none');
                    imgName.classList.add('d-none');
                    return;
                }
                const url = URL.createObjectURL(f);
                imgPrev.src = url;
                imgPrev.classList.remove('d-none');
                imgName.querySelector('span').textContent = f.name;
                imgName.classList.remove('d-none');
            });

            const pdfInput = document.getElementById('PdfFile');
            const pdfName = document.getElementById('pdfName');
            pdfInput?.addEventListener('change', e => {
                const f = e.target.files?.[0];
                if (!f) {
                    pdfName.classList.add('d-none');
                    return;
                }
                pdfName.querySelector('span').textContent = f.name;
                pdfName.classList.remove('d-none');
            });

            syncPills();
        })();

        function clampCopies() {
            const totalEl = document.getElementById('TotalCopies');
            const availEl = document.getElementById('AvailableCopies');
            if (!totalEl || !availEl) return;

            let total = parseInt(totalEl.value || '0');
            let avail = parseInt(availEl.value || '0');

            if (isNaN(total)) total = 0;
            if (isNaN(avail)) avail = 0;

            if (total < 0) total = 0;
            if (avail < 0) avail = 0;
            if (avail > total) avail = total;

            totalEl.value = total;
            availEl.value = avail;
        }

        function addBookRow() {
            const tbody = document.querySelector('#booksTable tbody');
            const idx = tbody.querySelectorAll('tr').length;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                                <td>
                                  <input name="Books[${idx}].BookId" value="0" type="hidden" />
                                  <input name="Books[${idx}].CatalogId" value="00000000-0000-0000-0000-000000000000" type="hidden" />
                                  <input name="Books[${idx}].Barcode" class="form-control" />
                                </td>
                                <td><input name="Books[${idx}].Status" class="form-control" value="Available" /></td>
                                <td><input name="Books[${idx}].Location" class="form-control" /></td>
                                <td><input name="Books[${idx}].AcquisitionDate" type="date" class="form-control" value="${new Date().toISOString().slice(0, 10)}" /></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBookRow(this)">✕</button>
                                </td>`;
            tbody.appendChild(tr);
            syncPills();
        }

        function removeBookRow(btn) {
            const tr = btn.closest('tr');
            tr.remove();
            const rows = document.querySelectorAll('#booksTable tbody tr');
            rows.forEach((row, i) => {
                row.querySelectorAll('input').forEach(inp => {
                    const name = inp.getAttribute('name');
                    if (name && name.startsWith('Books[')) {
                        const field = name.substring(name.indexOf('].') + 2);
                        inp.setAttribute('name', `Books[${i}].${field}`);
                    }
                });
            });
            syncPills();
        }

        function autoCount() {
            const rows = document.querySelectorAll('#booksTable tbody tr');
            const total = rows.length;
            let available = 0;
            rows.forEach(r => {
                const status = (r.querySelector('input[name*=".Status"]')?.value || '')
                    .trim()
                    .toLowerCase();
                if (status === 'available') {
                    available++;
                }
            });
            const totalEl = document.getElementById('TotalCopies');
            const availEl = document.getElementById('AvailableCopies');
            if (totalEl) totalEl.value = total;
            if (availEl) availEl.value = available;
            clampCopies();
            syncPills();
        }

        function syncPills() {
            const total = parseInt(document.getElementById('TotalCopies')?.value || '0');
            const avail = parseInt(document.getElementById('AvailableCopies')?.value || '0');
            document.getElementById('statTotal').textContent = isNaN(total) ? '0' : total.toString();
            document.getElementById('statAvail').textContent = isNaN(avail) ? '0' : avail.toString();
        }
    </script>
}
