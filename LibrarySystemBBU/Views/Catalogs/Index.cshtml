@model IEnumerable<LibrarySystemBBU.Models.Catalog>
@using System.Linq

@{
    ViewData["Title"] = "Catalogs";
    var totalCatalogs = Model?.Count() ?? 0;
    var sumTotalCopies = Model?.Sum(x => x.TotalCopies) ?? 0;
    var sumAvailable = Model?.Sum(x => x.AvailableCopies) ?? 0;

    // For Card view: show exactly 4 items (1 row x 4 columns)
    var four = (Model ?? Enumerable.Empty<LibrarySystemBBU.Models.Catalog>()).Take(4).ToList();
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<h2 class="page-title"><span class="logo-dot"></span> Catalogs</h2>

<div class="toolbar glass-surface">
    <a class="btn-glass btn-brand" asp-action="Create"><i class="bi bi-plus-circle"></i> Create New</a>

    <div class="segmented" role="group" aria-label="View">
        <button type="button" class="btn-toggle active" data-view="list"><i class="bi bi-list-ul"></i> List</button>
        <button type="button" class="btn-toggle" data-view="cards"><i class="bi bi-grid-3x3-gap"></i> Cards</button>
    </div>

    <div class="search-wrap">
        <i class="bi bi-search search-icon"></i>
        <input id="globalSearch" class="search-input" placeholder="Search title, author, ISBN, category…" />
        <button class="search-clear" type="button" id="clearSearch" title="Clear"><i class="bi bi-x-circle"></i></button>
    </div>

    <!-- SINGLE EXPORT BUTTON (Catalog + Book, EN+KH in one file) -->
    <div class="d-flex align-items-center gap-2 ms-2">
        <a class="btn-glass btn-outline glass-surface-pill"
           asp-action="Export">
            <i class="bi bi-download"></i> Export
        </a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
        <span class="pill glass-surface-pill"><i class="bi bi-journal-text"></i> Catalogs: <strong id="statCount">@totalCatalogs</strong></span>
        <span class="pill glass-surface-pill"><i class="bi bi-collection"></i> Total Copies: <strong id="statTotal">@sumTotalCopies</strong></span>
        <span class="pill glass-surface-pill"><i class="bi bi-box-seam"></i> Available: <strong id="statAvail">@sumAvailable</strong></span>
    </div>
</div>

<!-- LIST VIEW -->
<div id="view-list">
    <div class="table-wrap glass-surface">
        <!-- added glass-table class here -->
        <table class="table table-striped align-middle glass-table" id="catalogsTable">
            <thead>
                <tr>
                    <th style="min-width:220px;">Title</th>
                    <th>Author</th>
                    <th>ISBN</th>
                    <th>Category</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Available</th>
                    <!-- NEW: usage columns -->
                    <th class="text-end">Borrowed</th>
                    <th class="text-end">Read in Library</th>
                    <th style="min-width:220px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Model)
                {
                    var barcodes = c.Books == null
                    ? ""
                    : string.Join(" ", c.Books.Select(b => b.Barcode));

                    <tr data-title="@c.Title"
                        data-author="@c.Author"
                        data-isbn="@c.ISBN"
                        data-category="@c.Category"
                        data-total="@c.TotalCopies"
                        data-avail="@c.AvailableCopies"
                        data-barcodes="@barcodes">
                        <td>@c.Title</td>
                        <td>@c.Author</td>
                        <td>@c.ISBN</td>
                        <td>@c.Category</td>
                        <td class="text-end">@c.TotalCopies</td>
                        <td class="text-end">@c.AvailableCopies</td>
                        <td class="text-end">@c.BorrowCount</td>
                        <td class="text-end">@c.InLibraryCount</td>
                        <td class="text-nowrap actions">
                            <a class="btn-glass btn-outline btn-sm glass-surface-pill" asp-action="Details" asp-route-id="@c.CatalogId"><i class="bi bi-eye"></i> Details</a>
                            <a class="btn-glass btn-outline btn-sm glass-surface-pill" asp-action="Edit" asp-route-id="@c.CatalogId"><i class="bi bi-pencil-square"></i> Edit</a>
                            <a class="btn-glass btn-outline btn-sm glass-surface-pill" asp-action="Delete" asp-route-id="@c.CatalogId"><i class="bi bi-trash3"></i> Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination controls (List view only) -->
    <div class="pager" id="listPager">
        <button type="button" class="btn-glass btn-outline glass-surface-pill" id="prevPage"><i class="bi bi-chevron-left"></i> Prev</button>
        <span class="page-info" id="pageInfo">Page 1 / 1</span>
        <button type="button" class="btn-glass btn-outline glass-surface-pill" id="nextPage">Next <i class="bi bi-chevron-right"></i></button>
    </div>
</div>

<!-- CARD VIEW (exactly 1 row x 4 columns; only 4 items rendered) -->
<div class="cards-wrap" id="view-cards" style="display:none">
    @foreach (var c in four)
    {
        var title = c.Title ?? "";
        var author = c.Author ?? "";
        var isbn = c.ISBN ?? "";
        var category = c.Category ?? "";
        var image = string.IsNullOrWhiteSpace(c.ImagePath) ? null : c.ImagePath;
        var barcodesCard = c.Books == null
        ? ""
        : string.Join(" ", c.Books.Select(b => b.Barcode));

        <div class="catalog-card"
             data-title="@title"
             data-author="@author"
             data-isbn="@isbn"
             data-category="@category"
             data-total="@c.TotalCopies"
             data-avail="@c.AvailableCopies"
             data-barcodes="@barcodesCard">
            <div class="catalog-card-cover">
                @if (!string.IsNullOrWhiteSpace(image))
                {
                    <img src="@image" alt="@title cover" />
                }
                else
                {
                    <div class="placeholder"><i class="bi bi-image"></i></div>
                }
            </div>

            <div class="catalog-card-body">
                <div class="title"><i class="bi bi-journal-bookmark"></i> @title</div>
                <div class="meta"><i class="bi bi-person"></i> @author</div>
                <div class="meta"><i class="bi bi-upc-scan"></i> @isbn</div>
                <div class="meta"><i class="bi bi-tags"></i> @category</div>
                <div class="stats">
                    <span class="chip"><i class="bi bi-collection"></i> Total @c.TotalCopies</span>
                    <span class="chip"><i class="bi bi-box-seam"></i> Avail @c.AvailableCopies</span>
                    <!-- NEW usage chips -->
                    <span class="chip"><i class="bi bi-box-arrow-in-down"></i> Borrowed @c.BorrowCount</span>
                    <span class="chip"><i class="bi bi-building"></i> In Lib @c.InLibraryCount</span>
                </div>
            </div>

            <div class="catalog-card-actions">
                <a class="btn-glass btn-outline btn-sm" asp-action="Details" asp-route-id="@c.CatalogId"><i class="bi bi-eye"></i> Details</a>
                <a class="btn-glass btn-outline btn-sm" asp-action="Edit" asp-route-id="@c.CatalogId"><i class="bi bi-pencil-square"></i> Edit</a>
                <a class="btn-glass btn-outline btn-sm" asp-action="Delete" asp-route-id="@c.CatalogId"><i class="bi bi-trash3"></i> Delete</a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        (function () {
            const search = document.getElementById('globalSearch');
            const clearBtn = document.getElementById('clearSearch');
            const statCount = document.getElementById('statCount');
            const statTotal = document.getElementById('statTotal');
            const statAvail = document.getElementById('statAvail');

            const btns = document.querySelectorAll('.segmented .btn-toggle');
            const viewList = document.getElementById('view-list');
            const viewCards = document.getElementById('view-cards');
            const pager = document.getElementById('listPager');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');

            let pageSize = 10;
            let pageIndex = 1;

            btns.forEach(b => {
                b.addEventListener('click', () => {
                    btns.forEach(x => x.classList.remove('active'));
                    b.classList.add('active');
                    const v = b.getAttribute('data-view');
                    if (v === 'cards') {
                        viewCards.style.display = 'grid';
                        document.querySelector('#view-list .table-wrap').style.display = 'none';
                        pager.style.display = 'none';
                    } else {
                        viewCards.style.display = 'none';
                        document.querySelector('#view-list .table-wrap').style.display = 'block';
                        pager.style.display = 'flex';
                        pageIndex = 1;
                        apply();
                    }
                    apply();
                });
            });

            function getAllRows() {
                return Array.from(document.querySelectorAll('#catalogsTable tbody tr'));
            }

            function apply() {
                const q = (search.value || '').trim().toLowerCase();

                // LIST
                const rows = getAllRows();
                rows.forEach(tr => {
                    const text = [
                        tr.dataset.title || '',
                        tr.dataset.author || '',
                        tr.dataset.isbn || '',
                        tr.dataset.category || '',
                        tr.dataset.barcodes || '',
                        tr.dataset.total || '',
                        tr.dataset.avail || ''
                    ].join(' ').toLowerCase();

                    const show = !q || text.includes(q);
                    tr.dataset._filtered = show ? '1' : '0';
                });

                paginate();

                // CARDS
                document.querySelectorAll('#view-cards .catalog-card').forEach(card => {
                    const text = [
                        card.dataset.title || '',
                        card.dataset.author || '',
                        card.dataset.isbn || '',
                        card.dataset.category || '',
                        card.dataset.barcodes || '',
                        card.dataset.total || '',
                        card.dataset.avail || ''
                    ].join(' ').toLowerCase();

                    const show = !q || text.includes(q);
                    card.style.display = show ? '' : 'none';
                });

                const usingCards =
                    (viewCards.style.display !== 'none' &&
                        document.querySelector('#view-list .table-wrap').style.display === 'none');

                let count = 0, sumT = 0, sumA = 0;

                if (usingCards) {
                    document.querySelectorAll('#view-cards .catalog-card').forEach(card => {
                        if (card.style.display === 'none') return;
                        count++;
                        sumT += parseInt(card.dataset.total || '0');
                        sumA += parseInt(card.dataset.avail || '0');
                    });
                } else {
                    document.querySelectorAll('#catalogsTable tbody tr').forEach(tr => {
                        if (tr.style.display === 'none') return;
                        count++;
                        sumT += parseInt(tr.dataset.total || '0');
                        sumA += parseInt(tr.dataset.avail || '0');
                    });
                }

                statCount.textContent = count.toString();
                statTotal.textContent = sumT.toString();
                statAvail.textContent = sumA.toString();
            }

            function paginate() {
                const rows = getAllRows().filter(r => r.dataset._filtered === '1');

                const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
                if (pageIndex > totalPages) pageIndex = totalPages;
                if (pageIndex < 1) pageIndex = 1;

                let start = (pageIndex - 1) * pageSize;
                let end = start + pageSize;

                getAllRows().forEach(r => {
                    if (r.dataset._filtered === '0') { r.style.display = 'none'; return; }
                    r.style.display = 'none';
                });

                rows.slice(start, end).forEach(r => r.style.display = '');

                pageInfo.textContent = `Page ${rows.length ? pageIndex : 0} / ${rows.length ? Math.ceil(rows.length / pageSize) : 0}`;
                prevBtn.disabled = (pageIndex <= 1 || rows.length === 0);
                nextBtn.disabled = (pageIndex >= Math.ceil(rows.length / pageSize) || rows.length === 0);
            }

            // live search while typing
            search.addEventListener('input', () => {
                pageIndex = 1;
                apply();
            });

            // press Enter in search box
            search.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    pageIndex = 1;
                    apply();
                }
            });

            clearBtn.addEventListener('click', () => {
                search.value = '';
                search.focus();
                pageIndex = 1;
                apply();
            });

            prevBtn.addEventListener('click', () => { pageIndex--; apply(); });
            nextBtn.addEventListener('click', () => { pageIndex++; apply(); });

            document.querySelector('#view-list .table-wrap').style.display = 'block';
            pager.style.display = 'flex';
            apply();
        })();
    </script>
}
