@model IEnumerable<LibrarySystemBBU.Models.LibraryLog>
@using LibrarySystemBBU.Models

@{
    ViewData["Title"] = "Library Logs";
    var selStatus = (string?)ViewData["status"] ?? "All";
    string Active(string s) => string.Equals(selStatus, s, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    string fmt(DateTime? dt) => dt.HasValue ? dt.Value.ToString("yyyy-MM-dd HH:mm") : "—";
    var from = (string?)ViewData["from"] ?? "";
    var to = (string?)ViewData["to"] ?? "";

    string SafeTitle(LibraryLogItem? it)
    {
        var title = it?.Book?.Catalog?.Title ?? it?.Book?.Title ?? string.Empty;
        var code = it?.Book?.Barcode ?? string.Empty;
        if (string.IsNullOrWhiteSpace(title) && string.IsNullOrWhiteSpace(code)) return string.Empty;
        return string.IsNullOrWhiteSpace(code) ? title : $"{title} ({code})";
    }
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* ============================
               Library Logs – page scoped
               Reuse global glass + brand
               ============================ */

    #libraryLogsPage .top-bar {
        margin-bottom: 10px;
    }

    /* Small pill filter buttons */
    #libraryLogsPage .btn-pill-sm {
        border-radius: 999px;
        padding: .35rem .7rem;
        font-weight: 700;
        font-size: .88rem;
        border: 1px solid #dfe3ff;
        background: #f6f7ff;
        color: #2b2f7f;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        transition: .18s ease;
    }

        #libraryLogsPage .btn-pill-sm i {
            font-size: .9rem;
        }

        #libraryLogsPage .btn-pill-sm:hover {
            background: #e3e5ff;
            border-color: #c7ccff;
        }

        #libraryLogsPage .btn-pill-sm.active {
            background: #2b2f7f;
            color: #fff;
            border-color: #2b2f7f;
        }

    /* Filter row (From / To) */
    #libraryLogsPage .filters {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

        #libraryLogsPage .filters .form-control,
        #libraryLogsPage .filters .form-select {
            min-width: 160px;
        }

    /* Search input on the right */
    #libraryLogsPage .search-wrap {
        position: relative;
        display: flex;
        align-items: center;
        gap: .4rem;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(1,0,140,.12);
        background: #ffffff;
        box-shadow: 0 6px 14px rgba(1,0,140,.06);
    }

    #libraryLogsPage .search-input {
        border: 0;
        outline: 0;
        min-width: 220px;
        font-size: .9rem;
        background: transparent;
    }

    #libraryLogsPage .search-icon {
        font-size: .9rem;
        color: var(--muted, #667085);
    }

    #libraryLogsPage .search-clear {
        border: 0;
        background: transparent;
        color: var(--muted, #667085);
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* Table header style, reusing global brand */
    #libraryLogsPage thead th {
        background: linear-gradient(180deg, var(--brand-50, #e6e6ff), #ffffff);
        color: var(--brand-800, #05057a);
        vertical-align: middle;
        font-weight: 600;
        border-bottom-width: 2px;
    }

    /* Status badge chips */
    #libraryLogsPage .badge-soft {
        display: inline-block;
        padding: .25rem .5rem;
        border-radius: 999px;
        font-size: .78rem;
        font-weight: 600;
    }

    #libraryLogsPage .b-pending {
        background: #fff7e6;
        color: #8a5a00;
        border: 1px solid #ffe3ad;
    }

    #libraryLogsPage .b-approved {
        background: #e9fff0;
        color: #0c5d35;
        border: 1px solid #c8f0d7;
    }

    #libraryLogsPage .b-returned {
        background: #eef1ff;
        color: #2b2f7f;
        border: 1px solid #dfe3ff;
    }

    /* Icon-only actions */
    #libraryLogsPage .btn-icon {
        border: 0;
        background: transparent;
        padding: 0 .15rem;
        color: inherit;
        cursor: pointer;
    }

        #libraryLogsPage .btn-icon + .btn-icon {
            margin-left: .35rem;
        }

        #libraryLogsPage .btn-icon i {
            font-size: 1rem;
        }

    /* Actions column: avoid wrapping awkwardly */
    #libraryLogsPage .col-actions {
        white-space: nowrap;
    }

    /* Card glass: just reuse global .card-glass.glas-all-style */
    #libraryLogsPage .card-glass.glas-all-style {
        margin-top: 4px;
    }

    /* ======================
               SweetAlert glass theme
               ====================== */

    .swal2-container {
        z-index: 10000 !important;
    }

    .swal2-popup.glass-popup {
        backdrop-filter: blur(7px);
        -webkit-backdrop-filter: blur(12px);
        background: radial-gradient(circle at top left, rgba(1,0,140,.08), transparent 55%), radial-gradient(circle at bottom right, rgba(1,0,140,.06), transparent 55%), linear-gradient(145deg, rgba(255,255,255,.98), rgba(245,247,255,.96));
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,.7);
        box-shadow: 0 18px 45px rgba(15,23,42,.35);
        padding: 18px 20px 16px;
    }

        .swal2-popup.glass-popup .swal2-title {
            font-weight: 800;
            font-size: 1.05rem;
            color: var(--brand-800, #05057a);
        }

        .swal2-popup.glass-popup .swal2-html-container {
            font-size: .9rem;
            color: var(--muted,#ffffff);
        }

        .swal2-popup.glass-popup .swal2-actions {
            gap: 8px;
        }

        .swal2-popup.glass-popup .swal2-textarea,
        .swal2-popup.glass-popup .swal2-input {
            width: 100% !important;
            box-sizing: border-box;
        }
</style>

<div id="libraryLogsPage">
    <h2 class="page-title">
        <span class="logo-dot"></span>
        Library Logs
    </h2>

    <!-- Hidden AntiForgery token for AJAX -->
    <form id="__tokenForm">@Html.AntiForgeryToken()</form>

    <!-- Top bar: status filters + search + export/create -->
    <div class="top-bar d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2 card-glass glas-all-style ">
        <div class="d-flex gap-2 flex-wrap">
            <a class="btn-pill-sm @Active("All")"
               asp-action="Index"
               asp-route-status="All"
               asp-route-from="@from"
               asp-route-to="@to">
                <i class="bi bi-collection"></i> All
            </a>
            <a class="btn-pill-sm @Active("Pending")"
               asp-action="Index"
               asp-route-status="Pending"
               asp-route-from="@from"
               asp-route-to="@to">
                <i class="bi bi-hourglass-split"></i> Pending
            </a>
            <a class="btn-pill-sm @Active("Approved")"
               asp-action="Index"
               asp-route-status="Approved"
               asp-route-from="@from"
               asp-route-to="@to">
                <i class="bi bi-check2-circle"></i> Approved
            </a>
            <a class="btn-pill-sm @Active("Returned")"
               asp-action="Index"
               asp-route-status="Returned"
               asp-route-from="@from"
               asp-route-to="@to">
                <i class="bi bi-arrow-90deg-left"></i> Returned
            </a>
        </div>

        <div class="d-flex gap-2 flex-wrap align-items-center">
            <!-- LIVE SEARCH -->
            <div class="search-wrap">
                <i class="bi bi-search search-icon"></i>
                <input id="globalSearch"
                       class="search-input"
                       placeholder="Search student, phone, title, barcode…" />
                <button class="search-clear" type="button" id="clearSearch" title="Clear">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>

            <!-- Export + Create -->
            <div class="d-flex gap-2 flex-wrap">
                <div class="btn-group">
                    <button type="button"
                            class="btn-glass btn-outline dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                        <li>
                            <a class="dropdown-item"
                               asp-action="Export"
                               asp-route-status="@selStatus"
                               asp-route-from="@from"
                               asp-route-to="@to"
                               asp-route-format="csv">
                                <i class="bi bi-filetype-csv"></i> Export CSV
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item"
                               asp-action="Export"
                               asp-route-status="@selStatus"
                               asp-route-from="@from"
                               asp-route-to="@to"
                               asp-route-format="xls">
                                <i class="bi bi-file-earmark-excel"></i> Export Excel (.xls)
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item"
                               asp-action="Export"
                               asp-route-status="@selStatus"
                               asp-route-from="@from"
                               asp-route-to="@to"
                               asp-route-format="print"
                               target="_blank">
                                <i class="bi bi-printer"></i> Print View
                            </a>
                        </li>
                    </ul>
                </div>

                <a asp-action="Create" class="btn-glass btn-brand">
                    <i class="bi bi-plus-circle"></i> Create New
                </a>
            </div>
        </div>
    </div>

    <!-- FILTER: ONLY From + To -->
    <form method="get" class="mt-3 card-glass glas-all-style ">
        <div class="filters">
            <input type="hidden" name="status" value="@selStatus" />
            <div>
                <label class="form-label">From</label>
                <input name="from" value="@from" type="date" class="form-control" />
            </div>
            <div>
                <label class="form-label">To</label>
                <input name="to" value="@to" type="date" class="form-control" />
            </div>
            <div>
                <button class="btn-glass btn-outline" type="submit">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </div>
    </form>

    <div class="card-glass glas-all-style mt-2">
        <div class="card-header">
            <i class="bi bi-journal-text"></i> Recent Logs
        </div>
        <div class="p-3 table-responsive">
            @if (Model == null || !Model.Any())
            {
                <div class="text-muted p-3">
                    <i class="bi bi-inboxes"></i> No logs yet.
                </div>
            }
            else
            {
                <table class="table table-hover align-middle mb-0 " id="logsTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Student</th>
                            <th>Phone</th>
                            <th>Gender</th>
                            <th>Books</th>
                            <th>Visit Date</th>
                            <th>Created (UTC)</th>
                            <th style="width:320px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var x in Model)
                        {
                            var titles = (x.Items ?? new List<LibraryLogItem>())
                            .Select(SafeTitle)
                            .Where(s => !string.IsNullOrWhiteSpace(s))
                            .Distinct()
                            .ToList();

                            var st = x.Status ?? "Pending";
                            string badgeClass = st == "Approved"
                            ? "b-approved"
                            : st == "Returned"
                            ? "b-returned"
                            : "b-pending";

                            var booksText = titles.Count == 0 ? "" : string.Join(", ", titles);

                            <tr data-id="@x.LogId"
                                data-status="@st"
                                data-student="@x.StudentName"
                                data-phone="@x.PhoneNumber"
                                data-gender="@x.Gender"
                                data-books="@booksText"
                                data-visit="@x.VisitDate.ToString("yyyy-MM-dd")"
                                data-created="@x.CreatedUtc.ToString("yyyy-MM-dd HH:mm")">
                                <td class="col-status">
                                    <span class="badge-soft @badgeClass">@st</span>
                                </td>
                                <td>@x.StudentName</td>
                                <td>@x.PhoneNumber</td>
                                <td>@x.Gender</td>
                                <td>@(string.IsNullOrWhiteSpace(booksText) ? "—" : booksText)</td>
                                <td>@x.VisitDate.ToString("yyyy-MM-dd")</td>
                                <td>@x.CreatedUtc.ToString("yyyy-MM-dd HH:mm")</td>
                                <td class="col-actions">
                                    <a asp-action="Details"
                                       asp-route-id="@x.LogId"
                                       class="btn-icon"
                                       title="Details">
                                        <i class="bi bi-eye"></i>
                                    </a>

                                    <a asp-action="Edit"
                                       asp-route-id="@x.LogId"
                                       class="btn-icon"
                                       title="Edit">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>

                                    <button type="button"
                                            class="btn-icon btn-delete"
                                            data-id="@x.LogId"
                                            title="Delete">
                                        <i class="bi bi-trash3"></i>
                                    </button>

                                    @* Workflow buttons *@
                                    @if (st == "Pending")
                                    {
                                        <form asp-action="Approve"
                                              asp-route-id="@x.LogId"
                                              method="post"
                                              class="d-inline js-action"
                                              data-action="approve">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                        </form>
                                    }
                                    @if (st == "Approved")
                                    {
                                        <form asp-action="Return"
                                              asp-route-id="@x.LogId"
                                              method="post"
                                              class="d-inline js-action"
                                              data-action="return">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-primary">Return</button>
                                        </form>

                                        <form asp-action="ToPending"
                                              asp-route-id="@x.LogId"
                                              method="post"
                                              class="d-inline js-action"
                                              data-action="topending">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-secondary">To Pending</button>
                                        </form>
                                    }
                                    @if (st == "Returned")
                                    {
                                        <form asp-action="Unreturn"
                                              asp-route-id="@x.LogId"
                                              method="post"
                                              class="d-inline js-action"
                                              data-action="unreturn">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-warning">Unreturn</button>
                                        </form>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {

            const swalTheme = {
                background: 'transparent',
                color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a',
                confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#01008C',
                cancelButtonColor: '#94a3b8',
                customClass: {
                    popup: 'glass-popup'
                }
            };

            // =============== LIVE SEARCH =================
            const globalSearch = document.getElementById('globalSearch');
            const clearSearch = document.getElementById('clearSearch');

            function applySearch() {
                const kw = (globalSearch.value || '').trim().toLowerCase();

                document.querySelectorAll('#logsTable tbody tr').forEach(tr => {
                    const text = [
                        tr.dataset.status || '',
                        tr.dataset.student || '',
                        tr.dataset.phone || '',
                        tr.dataset.gender || '',
                        tr.dataset.books || '',
                        tr.dataset.visit || '',
                        tr.dataset.created || ''
                    ].join(' ').toLowerCase();

                    const show = !kw || text.includes(kw);
                    tr.style.display = show ? '' : 'none';
                });
            }

            if (globalSearch) {
                globalSearch.addEventListener('input', applySearch);

                globalSearch.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applySearch();
                    }
                });
            }

            if (clearSearch) {
                clearSearch.addEventListener('click', () => {
                    globalSearch.value = '';
                    globalSearch.focus();
                    applySearch();
                });
            }

            applySearch();

            // =============== DELETE =================
            function getAntiForgeryValue() {
                const input =
                    document.querySelector('#__tokenForm input[name="__RequestVerificationToken"]')
                    || document.querySelector('input[name="__RequestVerificationToken"]');
                return input ? input.value : '';
            }

            async function deleteLog(id, btn) {
                const res = await Swal.fire({
                    title: 'Delete this log?',
                    text: 'Only Pending logs can be deleted. This cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it',
                    cancelButtonText: 'Cancel',
                    reverseButtons: true,
                    ...swalTheme
                });
                if (!res.isConfirmed) return;

                btn.disabled = true;

                const fd = new FormData();
                fd.append('__RequestVerificationToken', getAntiForgeryValue());
                const url = '@Url.Action("Delete", "LibraryLogs")/' + id;

                let payload = null;
                let isJson = false;
                let r;

                try {
                    r = await fetch(url, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: fd
                    });

                    const ct = r.headers.get('content-type') || '';
                    isJson = ct.includes('application/json');

                    if (isJson) {
                        payload = await r.json();
                    }
                } catch (err) {
                    btn.disabled = false;
                    await Swal.fire({ icon: 'error', title: 'Error', text: 'Delete failed.', ...swalTheme });
                    return;
                }

                btn.disabled = false;

                if (!r.ok) {
                    await Swal.fire({ icon: 'error', title: 'Error', text: 'Delete failed.', ...swalTheme });
                    return;
                }

                if (isJson && payload && payload.ok === false) {
                    await Swal.fire({ icon: 'info', title: 'Info', text: payload.message || 'Cannot delete.', ...swalTheme });
                    return;
                }

                await Swal.fire({
                    icon: 'success',
                    title: 'Deleted',
                    text: (isJson && payload && payload.message) ? payload.message : 'Library log deleted.',
                    timer: 900,
                    showConfirmButton: false,
                    ...swalTheme
                });

                const row = document.querySelector(`#logsTable tbody tr[data-id="${id}"]`);
                if (row) row.remove();
                applySearch();
            }

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    deleteLog(id, btn);
                });
            });

            // =============== WORKFLOW (Approve / Return / Unreturn / ToPending) =================
            async function toastAndReload(text) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Done',
                    text: text || '',
                    timer: 800,
                    showConfirmButton: false,
                    ...swalTheme
                });
                window.location.reload();
            }

            function confirmText(action) {
                switch (action) {
                    case 'approve': return 'Approve this log?';
                    case 'return': return 'Mark this log as Returned?';
                    case 'unreturn': return 'Unreturn selected items?';
                    case 'topending': return 'Move this log to Pending?';
                    default: return 'Proceed?';
                }
            }

            document.addEventListener('submit', async e => {
                const form = e.target.closest('form.js-action');
                if (!form) return;
                e.preventDefault();

                const action = form.dataset.action;
                const ok = await Swal.fire({
                    title: confirmText(action),
                    text: 'Please confirm.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No',
                    reverseButtons: true,
                    ...swalTheme
                });
                if (!ok.isConfirmed) return;

                form.querySelectorAll('button').forEach(b => b.disabled = true);
                const fd = new FormData(form);

                let payload = null;
                let r;

                try {
                    r = await fetch(form.action, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: fd
                    });

                    const ct = r.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        payload = await r.json();
                    }
                } catch {
                    form.querySelectorAll('button').forEach(b => b.disabled = false);
                    await Swal.fire({ icon: 'error', title: 'Error', text: 'Operation failed.', ...swalTheme });
                    return;
                }

                form.querySelectorAll('button').forEach(b => b.disabled = false);

                if (!r.ok) {
                    await Swal.fire({ icon: 'error', title: 'Error', text: 'Operation failed.', ...swalTheme });
                    return;
                }

                if (payload && payload.ok === false) {
                    await Swal.fire({ icon: 'info', title: 'Info', text: payload.message || 'No change.', ...swalTheme });
                    return;
                }

                await toastAndReload((payload && payload.message) || 'Updated.');
            });
        })();
    </script>
}
