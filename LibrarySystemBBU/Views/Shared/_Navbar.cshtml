@using System.Security.Claims
@{
    var isAuth = User?.Identity?.IsAuthenticated ?? false;

    string fullName = isAuth
        ? (User.FindFirst("FullName")?.Value
           ?? User.FindFirst(ClaimTypes.Name)?.Value
           ?? "User")
        : "Guest";

    string? email = isAuth ? User.FindFirst(ClaimTypes.Email)?.Value : null;
    string? role = isAuth ? User.FindFirst(ClaimTypes.Role)?.Value : null;

    var avatarPath = isAuth
        ? (User.FindFirst("ProfilePicturePath")?.Value ?? "/admin-lte/img/avatar2.png")
        : "/admin-lte/img/avatar2.png";

    var avatar = Url.Content(avatarPath);
    var avatarFallback = Url.Content("/admin-lte/img/avatar2.png");
}
<link rel="stylesheet" href="~/font-awesome/css/all.min.css" />

<nav class="main-header navbar navbar-expand navbar-white navbar-surface shadow-sm px-3">
    @if (isAuth)
    {
        <!-- Right: Icons + Profile -->
        <ul class="navbar-nav ms-auto align-items-center gap-2">
            <li class="nav-item"><a class="nav-link text-dark" href="#"><i class="far fa-bell fs-5"></i></a></li>
            <li class="nav-item"><a class="nav-link text-dark" href="#"><i class="far fa-question-circle fs-5"></i></a></li>
            <li class="nav-item"><a class="nav-link text-dark" href="#"><i class="fas fa-cog fs-5"></i></a></li>

            <li class="nav-item dropdown">
                <a class="nav-link d-flex align-items-center gap-2" href="#" data-bs-toggle="dropdown">
                    <span class="fw-semibold text-dark d-none d-md-inline">@fullName</span>
                    <img src="@avatar" onerror="this.onerror=null;this.src='@avatarFallback';"
                         class="avatar-xs shadow-sm" alt="Profile">
                </a>

                <div class="dropdown-menu dropdown-menu-end mt-2 shadow-sm" style="min-width:260px;">
                    <div class="px-3 pt-3 pb-2">
                        <div class="d-flex align-items-center gap-2">
                            <img src="@avatar" onerror="this.onerror=null;this.src='@avatarFallback';"
                                 class="avatar-lg shadow-sm" alt="Avatar">
                            <div>
                                <div class="fw-semibold">@fullName</div>
                                @if (!string.IsNullOrWhiteSpace(email))
                                {
                                    <small class="text-muted">@email</small>
                                }
                                @if (!string.IsNullOrWhiteSpace(role))
                                {
                                    <div><span class="pill bg-white">@role</span></div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="/Account/Profile" class="dropdown-item">
                        <i class="fas fa-user me-2 text-info"></i> Profile
                    </a>
                    <div class="dropdown-divider"></div>
                    <form asp-controller="Account" asp-action="Logout" method="post" class="px-3">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="fas fa-sign-out-alt me-2"></i> Logout
                        </button>
                    </form>
                </div>
            </li>
        </ul>
    }
    else
    {
        <div class="ms-auto d-flex gap-2">
            <a class="btn btn-primary" asp-controller="Account" asp-action="Login">Login</a>
            <a class="btn btn-outline-primary" asp-controller="Account" asp-action="Register">Register</a>
        </div>
    }
</nav>

@section Scripts {
    <script>
        (function () {
            const box = document.getElementById('globalSearch');
            const dd = document.getElementById('searchDropdown');
            if (!box || !dd) return;

            function hide() { dd.style.display = 'none'; dd.innerHTML = ''; }
            function show() { dd.style.display = 'block'; }

            let t = null;

            box.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const q = box.value.trim();
                    if (q.length) window.location = '/Search/All?q=' + encodeURIComponent(q);
                }
            });

            box.addEventListener('input', () => {
                const q = box.value.trim();
                if (!q) { hide(); return; }
                clearTimeout(t);
                t = setTimeout(async () => {
                    try {
                        const r = await fetch('/Search/Typeahead?term=' + encodeURIComponent(q));
                        if (!r.ok) { hide(); return; }
                        const data = await r.json();
                        if (!Array.isArray(data) || data.length === 0) { hide(); return; }
                        dd.innerHTML = data.map(x => `
                                    <div class="search-item" onclick="window.location='${x.url}'">
                                        <i class="${x.icon}"></i>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold">${x.title}</div>
                                            <div class="text-muted small">${x.meta ?? ''}</div>
                                        </div>
                                        <span class="pill">${x.group}</span>
                                    </div>`).join('');
                        show();
                    } catch { hide(); }
                }, 200);
            });

            document.addEventListener('click', (e) => {
                if (!dd.contains(e.target) && e.target !== box) hide();
            });
        })();
    </script>
}
