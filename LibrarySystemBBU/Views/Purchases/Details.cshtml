@model LibrarySystemBBU.Models.Purchase
@using System.Linq
@{
    ViewData["Title"] = "Purchase Details";
    var details = (Model.PurchaseDetails ?? Enumerable.Empty<LibrarySystemBBU.Models.PurchaseDetail>())
        .OrderBy(x => x.PurchaseDetailId).ToList();
}

@functions {
    // Build a friendly book label consistent with BuildBookSelectList in the controller:
    // 1) Prefer Book.Title (with " — ISBN" when available)
    // 2) else Catalog.Title (with " — ISBN" when available)
    // 3) else "Book #<id>" (optionally " — <Barcode>" if present)
    string BookLabel(LibrarySystemBBU.Models.Book? b)
    {
        if (b == null) return string.Empty;

        var baseTitle = !string.IsNullOrWhiteSpace(b.Title)
            ? b.Title
            : (!string.IsNullOrWhiteSpace(b.Catalog?.Title)
                ? b.Catalog!.Title
                : $"Book #{b.BookId}");

        var text = !string.IsNullOrWhiteSpace(b.Catalog?.ISBN)
            ? $"{baseTitle} — {b.Catalog!.ISBN}"
            : baseTitle;

        if (text.StartsWith("Book #") && !string.IsNullOrWhiteSpace(b.Barcode))
            text = $"{text} — {b.Barcode}";

        return text;
    }
}

<style>
    :root {
        --navy: #000080;
    }

    .text-navy {
        color: var(--navy) !important;
    }

    .bg-navy {
        background-color: var(--navy) !important;
    }

    .btn-navy {
        --bs-btn-color: #fff;
        --bs-btn-bg: var(--navy);
        --bs-btn-border-color: var(--navy);
        --bs-btn-hover-bg: #000066;
        --bs-btn-hover-border-color: #000066;
        --bs-btn-active-bg: #000055;
        --bs-btn-active-border-color: #000055;
    }

    /* 3D card look */
    .elev-card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 1rem;
        background: #fff;
        box-shadow: 0 10px 24px rgba(0,0,128,.10);
        transition: transform .18s ease, box-shadow .18s ease;
    }

        .elev-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 36px rgba(0,0,128,.16);
        }

    .kv .key {
        min-width: 11rem;
        font-weight: 600;
        color: var(--navy);
    }

    .kv .val {
        word-break: break-word;
    }

    .search-wrap {
        border: 1px solid rgba(0,0,128,.25);
        border-radius: .75rem;
        padding: .5rem .75rem;
        background: #fff;
        box-shadow: 0 4px 14px rgba(0,0,128,.08);
    }

    .table thead th {
        vertical-align: middle;
    }
</style>

<div class="container mt-4 card-glass glas-all-style">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
        <h2 class="mb-0 text-navy d-flex align-items-center gap-2">
            <i class="fa-solid fa-receipt"></i> Purchase Details
        </h2>
        <div class="d-flex gap-2">
            <a asp-action="Edit" asp-route-id="@Model.PurchaseId" class="btn btn-navy">
                <i class="fa-regular fa-pen-to-square me-1"></i> Edit
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left me-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Header info -->
    <div class="elev-card p-3 p-md-4 mt-3">
        <div class="row gy-3 kv">
            <div class="col-12 col-md-6 d-flex">
                <div class="key me-2"><i class="fa-regular fa-calendar-days me-1"></i>Purchase Date</div>
                <div class="val">@Model.PurchaseDate.ToString("yyyy-MM-dd")</div>
            </div>
            <div class="col-12 col-md-6 d-flex">
                <div class="key me-2"><i class="fa-solid fa-book me-1"></i>Book</div>
                <div class="val">@BookLabel(Model.Book)</div>
            </div>
            <div class="col-12 col-md-6 d-flex">
                <div class="key me-2"><i class="fa-solid fa-truck me-1"></i>Supplier</div>
                <div class="val"><span class="badge rounded-pill bg-navy">@Model.Supplier</span></div>
            </div>
            <div class="col-12 col-md-6 d-flex">
                <div class="key me-2"><i class="fa-solid fa-sack-dollar me-1"></i>Cost</div>
                <div class="val">@Model.Cost.ToString("N2")</div>
            </div>
            <div class="col-12 d-flex">
                <div class="key me-2"><i class="fa-regular fa-note-sticky me-1"></i>Notes</div>
                <div class="val">@Model.Notes</div>
            </div>
        </div>
    </div>

    <!-- Line items header + search -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-4">
        <h5 class="mb-0 text-navy d-flex align-items-center gap-2">
            <i class="fa-solid fa-table-list"></i> Line Items
            <span class="badge rounded-pill bg-navy ms-1" id="rowsCountBadge">@details.Count item@(details.Count == 1 ? "" : "s")</span>
        </h5>
        <div class="search-wrap d-flex align-items-center gap-2 w-100 w-md-auto">
            <i class="fa-solid fa-magnifying-glass text-navy"></i>
            <input id="lineSearch" type="search" class="form-control border-0 p-0"
                   placeholder="ស្វែងរកគ្រប់ជួរឈរ (Book / Qty / Unit Price / Line Total)" />
        </div>
    </div>

    <!-- Line items table -->
    <div class="table-responsive mt-2">
        <table class="table table-sm table-hover table-striped table-bordered align-middle mb-0" id="detailsTbl">
            <thead class="table-light">
                <tr class="text-navy">
                    <th><i class="fa-solid fa-book me-1"></i>Book</th>
                    <th class="text-end"><i class="fa-solid fa-arrow-up-1-9 me-1"></i>Quantity</th>
                    <th class="text-end"><i class="fa-solid fa-dollar-sign me-1"></i>Unit Price</th>
                    <th class="text-end"><i class="fa-solid fa-calculator me-1"></i>Line Total</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in details)
                {
                    <tr>
                        <td>@BookLabel(d.Book)</td>
                        <td class="text-end">@d.Quantity</td>
                        <td class="text-end">@d.UnitPrice.ToString("N2")</td>
                        <td class="text-end">@d.LineTotal.ToString("N2")</td>
                    </tr>
                }
                @if (!details.Any())
                {
                    <tr><td colspan="4" class="text-center text-muted">No line items.</td></tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th class="text-end">Totals (visible):</th>
                    <th class="text-end"><span id="tQty">0</span></th>
                    <th class="text-end">—</th>
                    <th class="text-end"><span id="tCost">0.00</span></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const input = document.getElementById('lineSearch');
            const tbl = document.getElementById('detailsTbl');
            const rows = Array.from(tbl.querySelectorAll('tbody tr'));
            const rowsCountBadge = document.getElementById('rowsCountBadge');
            const tQty = document.getElementById('tQty');
            const tCost = document.getElementById('tCost');

            const norm = s => (s||'').toString().toLowerCase();
            const matchAll = (txt, q) => {
                const terms = norm(q).split(/\s+/).filter(Boolean);
                const h = norm(txt);
                return terms.every(t => h.includes(t));
            };
            const parseNum = v => {
                const n = parseFloat((v||'').toString().replace(/,/g,''));
                return Number.isFinite(n) ? n : 0;
            };
            const recalcTotals = () => {
                let qty = 0, cost = 0, visible = 0;
                rows.forEach(tr => {
                    if (tr.style.display !== 'none') {
                        visible++;
                        qty  += parseNum(tr.children[1]?.innerText);
                        cost += parseNum(tr.children[3]?.innerText);
                    }
                });
                rowsCountBadge.textContent = `${visible} item${visible===1?'':'s'}`;
                tQty.textContent = qty.toString();
                tCost.textContent = (cost||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            };
            const applyFilter = (q) => {
                rows.forEach(tr => {
                    const txt = tr.innerText || tr.textContent || '';
                    tr.style.display = matchAll(txt, q) ? '' : 'none';
                });
                recalcTotals();
            };

            input?.addEventListener('input', e => applyFilter(e.target.value));

            // initial totals
            recalcTotals();
        })();
    </script>
}
