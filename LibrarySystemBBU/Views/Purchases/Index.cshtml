@model IEnumerable<LibrarySystemBBU.Models.Purchase>

@{
    ViewData["Title"] = "Purchases";

    var total = Model?.Count() ?? 0;
    var qtySum = Model?.Sum(x => x.Quantity) ?? 0;
    var costSum = Model?.Sum(x => x.Cost) ?? 0m;

    var suppliers = Model?
        .Select(x => x.Supplier ?? "")
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .Distinct()
        .OrderBy(s => s)
        .ToList() ?? new List<string>();
}

@functions {
    // Reuse the same label logic as BuildBookSelectList / Details:
    // 1) Prefer Book.Title (+ " — ISBN" if available)
    // 2) else Catalog.Title (+ " — ISBN" if available)
    // 3) else "Book #<id>" (optionally " — <Barcode>")
    string BookLabel(LibrarySystemBBU.Models.Book? b)
    {
        if (b == null) return string.Empty;

        var baseTitle = !string.IsNullOrWhiteSpace(b.Title)
            ? b.Title
            : (!string.IsNullOrWhiteSpace(b.Catalog?.Title)
                ? b.Catalog!.Title
                : $"Book #{b.BookId}");

        var text = !string.IsNullOrWhiteSpace(b.Catalog?.ISBN)
            ? $"{baseTitle} — {b.Catalog!.ISBN}"
            : baseTitle;

        if (text.StartsWith("Book #") && !string.IsNullOrWhiteSpace(b.Barcode))
            text = $"{text} — {b.Barcode}";

        return text;
    }
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* Mobile purchase card (use global glass variables) */
    .purchase-card {
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, .55);
        background: rgba(255, 255, 255, .90);
        box-shadow: var(--shadow-2);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        transition: transform .18s, box-shadow .18s;
    }

        .purchase-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
        }

        .purchase-card .badge {
            font-size: .75rem;
        }
</style>

<h2 class="page-title">
    <span class="logo-dot"></span> Purchases
</h2>

<div class="toolbar">
    <a asp-action="Create" class="btn-glass btn-brand">
        <i class="bi bi-plus-circle"></i> New Purchase
    </a>

    <div class="segmented" role="group" aria-label="Date filters">
        <button type="button" class="btn-toggle active" data-filter="all">
            <i class="bi bi-grid"></i> All
        </button>
        <button type="button" class="btn-toggle" data-filter="thisMonth">
            <i class="bi bi-calendar-month"></i> This Month
        </button>
        <button type="button" class="btn-toggle" data-filter="last30">
            <i class="bi bi-clock-history"></i> Last 30 Days
        </button>
        <button type="button" class="btn-toggle" data-filter="today">
            <i class="bi bi-calendar-event"></i> Today
        </button>
    </div>

    <div class="d-flex align-items-center gap-2">
        <select id="supplierFilter" class="form-select form-select-sm">
            <option value="">All suppliers</option>
            @foreach (var s in suppliers)
            {
                <option value="@s">@s</option>
            }
        </select>
    </div>

    <div class="search-wrap">
        <i class="bi bi-search search-icon"></i>
        <input id="globalSearch"
               class="search-input"
               placeholder="Search (date, book, supplier, qty, cost, notes)…" />
        <button class="search-clear"
                type="button"
                id="clearSearch"
                title="Clear">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
        <span class="pill">
            <i class="bi bi-layers"></i>
            Total: <strong id="statTotal">@total</strong>
        </span>
        <span class="pill">
            <i class="bi bi-123"></i>
            Qty: <strong id="statQty">@qtySum</strong>
        </span>
        <span class="pill">
            <i class="bi bi-cash-coin"></i>
            Cost: <strong id="statCost">@costSum.ToString("N2")</strong>
        </span>

        <!-- Updated: server-side Excel export -->
        <a asp-action="Export" class="btn-glass btn-outline">
            <i class="bi bi-file-earmark-excel"></i> Export
        </a>
    </div>
</div>

<!-- GLASS CARD: TABLE (desktop) -->
<div class="card-glass glas-all-style mt-3">
    <div class="section-title">
        <i class="bi bi-table"></i> Purchases List
    </div>

    <div class="table-wrap d-none d-md-block">
        <table id="purchasesTable" class="table table-striped align-middle mb-0 glass-table">
            <thead>
                <tr>
                    <th>Purchase Date</th>
                    <th>Book</th>
                    <th>Supplier</th>
                    <th class="text-end">Quantity</th>
                    <th class="text-end">Cost</th>
                    <th>Notes</th>
                    <th style="min-width:210px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-date="@item.PurchaseDate.ToString("yyyy-MM-dd")"
                        data-supplier="@((item.Supplier ?? "").ToLower())"
                        data-qty="@item.Quantity"
                        data-cost="@item.Cost">
                        <td>@item.PurchaseDate.ToString("yyyy-MM-dd")</td>
                        <td>@BookLabel(item.Book)</td>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(item.Supplier))
                            {
                                <span class="pill">
                                    <i class="bi bi-truck"></i> @item.Supplier
                                </span>
                            }
                        </td>
                        <td class="text-end">@item.Quantity</td>
                        <td class="text-end">@item.Cost.ToString("N2")</td>
                        <td>@item.Notes</td>
                        <td class="text-nowrap">
                            <a asp-action="Details"
                               asp-route-id="@item.PurchaseId"
                               class="btn-glass btn-outline btn-sm">
                                <i class="bi bi-eye"></i> Details
                            </a>
                            <a asp-action="Edit"
                               asp-route-id="@item.PurchaseId"
                               class="btn-glass btn-outline btn-sm">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <a asp-action="Delete"
                               asp-route-id="@item.PurchaseId"
                               class="btn-glass btn-outline btn-sm">
                                <i class="bi bi-trash3"></i> Delete
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- GLASS CARD: MOBILE CARDS -->
<div class="card-glass glas-all-style mt-3 d-md-none">
    <div class="section-title">
        <i class="bi bi-phone"></i> Purchases (mobile view)
    </div>

    <div id="cardsList" class="d-grid gap-3 mt-2">
        @foreach (var item in Model)
        {
            <div class="purchase-card p-3"
                 data-date="@item.PurchaseDate.ToString("yyyy-MM-dd")"
                 data-supplier="@((item.Supplier ?? "").ToLower())"
                 data-qty="@item.Quantity"
                 data-cost="@item.Cost">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">
                            <i class="bi bi-calendar2-week me-1"></i>
                            @item.PurchaseDate.ToString("yyyy-MM-dd")
                        </div>
                        <div class="mt-1">
                            <i class="bi bi-book me-1"></i>@BookLabel(item.Book)
                        </div>
                        @if (!string.IsNullOrWhiteSpace(item.Supplier))
                        {
                            <div class="mt-1">
                                <span class="badge rounded-pill text-bg-primary">
                                    <i class="bi bi-truck me-1"></i>@item.Supplier
                                </span>
                            </div>
                        }
                    </div>
                    <div class="d-flex flex-wrap gap-1">
                        <a asp-action="Details"
                           asp-route-id="@item.PurchaseId"
                           class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a asp-action="Edit"
                           asp-route-id="@item.PurchaseId"
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a asp-action="Delete"
                           asp-route-id="@item.PurchaseId"
                           class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </div>
                <hr class="my-3" />
                <div class="row g-2 small">
                    <div class="col-12">
                        <i class="bi bi-123 me-1"></i><strong>Quantity:</strong> @item.Quantity
                    </div>
                    <div class="col-12">
                        <i class="bi bi-cash-coin me-1"></i><strong>Cost:</strong> @item.Cost.ToString("N2")
                    </div>
                    <div class="col-12">
                        <i class="bi bi-stickies me-1"></i><strong>Notes:</strong> @item.Notes
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div id="noMatches" class="alert alert-warning mt-3 d-none" role="alert">
    <i class="bi bi-question-circle"></i> No matching results for your filters/search.
</div>

@section Scripts {
    <script>
        (() => {
            const $ = s => document.querySelector(s);
            const $$ = s => Array.from(document.querySelectorAll(s));

            const segBtns = $$('.segmented .btn-toggle');
            const search = $('#globalSearch');
            const clearBtn = $('#clearSearch');
            const supSel = $('#supplierFilter');
            const noMsg = $('#noMatches');

            const rows = () => $$('#purchasesTable tbody tr');
            const cards = () => $$('#cardsList .purchase-card');

            const statTotal = $('#statTotal');
            const statQty = $('#statQty');
            const statCost = $('#statCost');

            const today = new Date(new Date().toISOString().slice(0, 10));
            const addDays = (d, n) => new Date(d.getTime() + n * 86400000);
            const firstOfMonth = d => new Date(d.getFullYear(), d.getMonth(), 1);

            function inPreset(date, preset) {
                if (!preset || preset === 'all') return true;
                const dt = new Date(date);
                if (preset === 'today') {
                    return dt.getTime() === today.getTime();
                }
                if (preset === 'last30') {
                    const from = addDays(today, -30);
                    return dt >= from && dt <= today;
                }
                if (preset === 'thisMonth') {
                    const from = firstOfMonth(today);
                    return dt >= from && dt <= today;
                }
                return true;
            }

            function matchSupplier(el, supplier) {
                if (!supplier) return true;
                const s = (el.getAttribute('data-supplier') || '').toLowerCase();
                return s === supplier.toLowerCase();
            }

            const norm = s => (s || '').toLowerCase().trim();
            function matchSearch(el, q) {
                if (!q) return true;
                const txt = (el.innerText || el.textContent || '').toLowerCase();
                return txt.includes(q);
            }

            function applyUI(preset) {
                segBtns.forEach(b => b.classList.remove('active'));
                const active = segBtns.find(b => b.dataset.filter === preset);
                if (active) active.classList.add('active');

                const q = norm(search.value);
                const sup = supSel.value;

                let vis = 0, qty = 0, cost = 0;

                const show = (el, showIt) => { el.style.display = showIt ? '' : 'none'; };

                // table rows
                rows().forEach(r => {
                    const dt = r.getAttribute('data-date');
                    const ok = inPreset(dt, preset) && matchSupplier(r, sup) && matchSearch(r, q);
                    show(r, ok);
                    if (ok) {
                        vis++;
                        qty += parseInt(r.getAttribute('data-qty') || '0');
                        cost += parseFloat(r.getAttribute('data-cost') || '0');
                    }
                });

                // mobile cards
                cards().forEach(c => {
                    const dt = c.getAttribute('data-date');
                    const ok = inPreset(dt, preset) && matchSupplier(c, sup) && matchSearch(c, q);
                    show(c, ok);
                });

                statTotal.textContent = vis.toString();
                statQty.textContent = qty.toString();
                statCost.textContent = (isNaN(cost) ? 0 : cost)
                    .toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                noMsg.classList.toggle('d-none', vis !== 0);
            }

            segBtns.forEach(b => b.addEventListener('click', () => applyUI(b.dataset.filter)));

            search.addEventListener('input', () => {
                const active = document.querySelector('.segmented .btn-toggle.active')?.dataset.filter || 'all';
                applyUI(active);
            });

            clearBtn.addEventListener('click', () => {
                search.value = '';
                search.focus();
                const active = document.querySelector('.segmented .btn-toggle.active')?.dataset.filter || 'all';
                applyUI(active);
            });

            supSel.addEventListener('change', () => {
                const active = document.querySelector('.segmented .btn-toggle.active')?.dataset.filter || 'all';
                applyUI(active);
            });

            // init
            applyUI('all');
        })();
    </script>
}
