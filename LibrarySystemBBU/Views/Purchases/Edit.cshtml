@model LibrarySystemBBU.Models.Purchase
@using Microsoft.AspNetCore.Mvc.ViewFeatures
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Edit Purchase";
    var bookSelect = (SelectList)ViewData["BookId"];
    var list = (Model.PurchaseDetails ?? Enumerable.Empty<LibrarySystemBBU.Models.PurchaseDetail>()).ToList();
}

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    :root {
        --navy: #000080;
    }

    .text-navy {
        color: var(--navy) !important;
    }

    .bg-navy {
        background-color: var(--navy) !important;
    }

    .btn-navy {
        --bs-btn-color: #fff;
        --bs-btn-bg: var(--navy);
        --bs-btn-border-color: var(--navy);
        --bs-btn-hover-bg: #000066;
        --bs-btn-hover-border-color: #000066;
        --bs-btn-active-bg: #000055;
        --bs-btn-active-border-color: #000055;
    }

    .elev-card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 1rem;
        background: #fff;
        box-shadow: 0 10px 24px rgba(0,0,128,.10);
    }

    .section-title {
        color: var(--navy);
        font-weight: 700;
    }

    .table thead th {
        vertical-align: middle;
    }

    .sticky-actions {
        position: sticky;
        bottom: -1px;
        z-index: 3;
        background: #fff;
        border-top: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 -8px 20px rgba(0,0,128,.08);
        border-bottom-left-radius: 1rem;
        border-bottom-right-radius: 1rem;
        padding: .75rem;
    }

    .w-45 {
        width: 45%
    }

    .w-20 {
        width: 20%
    }

    .w-15 {
        width: 15%
    }

    .w-5 {
        width: 5%
    }
    /* Select2 height sync with Bootstrap */
    .select2-container .select2-selection--single {
        height: 38px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 38px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 38px;
    }

    .input-group {
        flex-wrap: nowrap;
        gap: 2px;
    }
</style>

<div class="container mt-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
        <h2 class="mb-0 text-navy d-flex align-items-center gap-2">
            <i class="fa-solid fa-pen-to-square"></i> Edit Purchase
        </h2>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fa-solid fa-list me-1"></i> Back to List
        </a>
    </div>

    <form asp-action="Edit" method="post" class="elev-card mt-3">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="PurchaseId" />
        <div class="p-3 p-md-4">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="PurchaseDate" class="form-label">
                        <i class="fa-regular fa-calendar-days me-1 text-navy"></i>@Html.DisplayNameFor(m => m.PurchaseDate)
                    </label>
                    <input asp-for="PurchaseDate" class="form-control" />
                    <span asp-validation-for="PurchaseDate" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Supplier" class="form-label">
                        <i class="fa-solid fa-truck me-1 text-navy"></i>@Html.DisplayNameFor(m => m.Supplier)
                    </label>
                    <input asp-for="Supplier" class="form-control" />
                    <span asp-validation-for="Supplier" class="text-danger"></span>
                </div>
                <div class="col-md-5">
                    <label asp-for="Notes" class="form-label">
                        <i class="fa-regular fa-note-sticky me-1 text-navy"></i>@Html.DisplayNameFor(m => m.Notes)
                    </label>
                    <input asp-for="Notes" class="form-control" />
                    <span asp-validation-for="Notes" class="text-danger"></span>
                </div>
            </div>

            <hr class="my-4" />

            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h5 class="section-title m-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-table-list"></i> Line Items
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="add3Btn">
                        <i class="fa-solid fa-plus me-1"></i> Add 3 Rows
                    </button>
                    <button type="button" class="btn btn-navy" id="addRowBtn">
                        <i class="fa-solid fa-plus me-1"></i> Add Row
                    </button>
                </div>
            </div>

            <div class="table-responsive mt-2">
                <table class="table table-sm table-hover table-striped table-bordered align-middle" id="detailsTable">
                    <thead class="table-light">
                        <tr class="text-navy">
                            <th class="w-45"><i class="fa-solid fa-book me-1"></i>Book (searchable)</th>
                            <th class="text-end w-15"><i class="fa-solid fa-arrow-up-1-9 me-1"></i>Quantity</th>
                            <th class="text-end w-20"><i class="fa-solid fa-dollar-sign me-1"></i>Unit Price</th>
                            <th class="text-end w-20"><i class="fa-solid fa-calculator me-1"></i>Line Total</th>
                            <th class="w-5"></th>
                        </tr>
                    </thead>
                    <tbody id="detailBody">
                        @for (var i = 0; i < list.Count; i++)
                        {
                            var d = list[i];
                            @await Html.PartialAsync("_DetailRow", d,
                            new ViewDataDictionary(ViewData) { { "index", i }, { "bookSelect", bookSelect } })
                                                }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th class="text-end">Totals:</th>
                            <th class="text-end"><span id="footerQty">0</span></th>
                            <th class="text-end">—</th>
                            <th class="text-end"><span id="footerCost">0.00</span></th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="sticky-actions d-flex justify-content-between align-items-center gap-2">
            <div class="small text-muted d-flex align-items-center gap-2">
                <i class="fa-regular fa-circle-question"></i>
                Line totals = Quantity × Unit Price (auto)
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-navy">
                    <i class="fa-solid fa-floppy-disk me-1"></i> Save
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-xmark me-1"></i> Cancel
                </a>
            </div>
        </div>

        <!-- Hidden template row -->
        <table class="d-none">
            <tbody id="detailRowTemplate">
                @await Html.PartialAsync(
                                "_DetailRow",
                                new LibrarySystemBBU.Models.PurchaseDetail(),
                                new ViewDataDictionary(ViewData) {
                                { "index", "__index__" },
                                { "bookSelect", bookSelect }
                                }
                                )
            </tbody>
        </table>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- jQuery + Select2 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        (function () {
            const body = document.getElementById('detailBody');
            const template = document.getElementById('detailRowTemplate').innerHTML;
            const addBtn = document.getElementById('addRowBtn');
            const add3Btn = document.getElementById('add3Btn');
            const footerQty = document.getElementById('footerQty');
            const footerCost = document.getElementById('footerCost');

            function initSelect2(scope){
                $(scope).find('select.book-select').select2({
                    placeholder: 'Search book by title…',
                    width: '100%'
                });
            }

            function parseNum(v, decimals) {
                const n = parseFloat(v);
                if (Number.isFinite(n)) return decimals != null ? Number(n.toFixed(decimals)) : n;
                return 0;
            }
            function formatMoney(n) {
                return (n ?? 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function recalcFooter() {
                let qty = 0, cost = 0;
                body.querySelectorAll('tr').forEach(tr => {
                    const q  = tr.querySelector('input[id$="__Quantity"]');
                    const lt = tr.querySelector('input[id$="__LineTotal"]');
                    qty  += parseNum(q?.value || '0', 0);
                    cost += parseNum(lt?.value || '0', 2);
                });
                footerQty.textContent = qty.toString();
                footerCost.textContent = formatMoney(cost);
            }

            function clampNonNegative(input, decimals) {
                const n = parseNum(input.value || '0', decimals);
                if (n < 0) input.value = Math.abs(n).toFixed(decimals ?? 0);
            }

            function wireRow(tr) {
                const q  = tr.querySelector('input[id$="__Quantity"]');
                const up = tr.querySelector('input[id$="__UnitPrice"]');
                const lt = tr.querySelector('input[id$="__LineTotal"]');
                if (lt) lt.readOnly = true;

                function recalc() {
                    if (q) clampNonNegative(q, 0);
                    if (up) clampNonNegative(up, 2);
                    const qty = parseNum(q?.value || '0', 0);
                    const price = parseNum(up?.value || '0', 2);
                    if (lt) lt.value = (qty * price).toFixed(2);
                    recalcFooter();
                }
                q?.addEventListener('input', recalc);
                up?.addEventListener('input', recalc);
                recalc();
            }

            function addRow(focus=true) {
                const index = body.querySelectorAll('tr').length;
                const html = template.replaceAll('__index__', index);
                const wrapper = document.createElement('tbody');
                wrapper.innerHTML = html.trim();
                const tr = wrapper.firstElementChild;
                body.appendChild(tr);
                initSelect2(tr);
                wireRow(tr);
                if (focus) tr.querySelector('select, input')?.focus();
                recalcFooter();
            }

            // Wire existing rows (from server)
            Array.from(body.querySelectorAll('tr')).forEach(function(tr){
                initSelect2(tr);
                wireRow(tr);
            });

            // Add row buttons
            addBtn.addEventListener('click', () => addRow(true));
            add3Btn.addEventListener('click', () => { addRow(false); addRow(false); addRow(true); });

            // Remove row (delegated; uses .btn-remove-row inside partial)
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-remove-row');
                if (btn) {
                    e.preventDefault();
                    const tr = btn.closest('tr');
                    if (tr && tr.parentNode) {
                        $(tr).find('select.book-select').each(function(){ $(this).select2('destroy'); });
                        tr.parentNode.removeChild(tr);
                        recalcFooter();
                    }
                }
            });

            // Initial footer totals
            recalcFooter();
        })();
    </script>
}
