@model LibrarySystemBBU.Models.Adjustment
@{
    ViewData["Title"] = "Adjustment Details";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* Just a small helper for the inline search bar */
    .search-wrap {
        border-radius: 999px;
        border: 1px solid rgba(1,0,140,.18);
        padding: .25rem .75rem;
        background: rgba(255,255,255,.9);
        display: flex;
        align-items: center;
        gap: .4rem;
        box-shadow: 0 4px 14px rgba(1,0,140,.10);
        max-width: 320px;
        width: 100%;
    }

        .search-wrap input {
            border: 0;
            background: transparent;
            box-shadow: none;
            padding: 0;
            font-size: .9rem;
        }

            .search-wrap input:focus {
                outline: none;
                box-shadow: none;
            }
</style>

<div class="container mt-4">

    <h2 class="page-title">
        <span class="logo-dot"></span>
        Adjustment Details
    </h2>

    <div class="toolbar">
        <a asp-action="Index" class="btn-glass btn-outline">
            <i class="bi bi-list"></i> Back to List
        </a>

        <a asp-action="Edit" asp-route-id="@Model.AdjustmentId" class="btn-glass btn-brand">
            <i class="bi bi-pencil-square"></i> Edit
        </a>

        <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
            <span class="pill">
                <i class="bi bi-calendar3"></i>
                Date: <strong>@Model.AdjustmentDate.ToString("yyyy-MM-dd")</strong>
            </span>
            <span class="pill">
                <i class="bi bi-tag"></i>
                Type: <strong>@Model.AdjustmentType</strong>
            </span>
            <span class="pill">
                <i class="bi bi-plus-slash-minus"></i>
                Total Change: <strong>@Model.QuantityChange</strong>
            </span>
        </div>
    </div>

    <!-- Header info -->
    <div class="card-glass glas-all-style mt-3">
        <div class="section-title">
            <i class="bi bi-info-circle"></i> Adjustment Info
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-calendar3 me-1"></i>Date
                </label>
                <input class="form-control" value="@Model.AdjustmentDate.ToString("yyyy-MM-dd")" disabled />
            </div>

            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-tag me-1"></i>Type
                </label>
                <div>
                    <span class="pill">@Model.AdjustmentType</span>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-journal-text me-1"></i>Catalog
                </label>
                <input class="form-control"
                       value="@(Model?.Catalog == null
                                    ? "(no catalog)"
                                    : (string.IsNullOrEmpty(Model.Catalog.ISBN)
                                        ? Model.Catalog.Title
                                        : $"{Model.Catalog.Title} ({Model.Catalog.ISBN})"))"
                       disabled />
            </div>

            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-plus-slash-minus me-1"></i>Quantity Change
                </label>
                <input class="form-control" value="@Model.QuantityChange" disabled />
            </div>

            <div class="col-12">
                <label class="form-label">
                    <i class="bi bi-chat-text me-1"></i>Reason
                </label>
                <textarea class="form-control" rows="2" disabled>@Model.Reason</textarea>
            </div>

            <div class="col-md-6">
                <label class="form-label">
                    <i class="bi bi-person-circle me-1"></i>Adjusted By
                </label>
                <input class="form-control" value="@Model.AdjustedByUser?.UserName" disabled />
            </div>

            <div class="col-md-3">
                <label class="form-label">
                    <i class="bi bi-clock-history me-1"></i>Created
                </label>
                <input class="form-control" value="@Model.Created?.ToString("u")" disabled />
            </div>

            <div class="col-md-3">
                <label class="form-label">
                    <i class="bi bi-clock me-1"></i>Modified
                </label>
                <input class="form-control" value="@Model.Modified?.ToString("u")" disabled />
            </div>
        </div>
    </div>

    <!-- Detail rows -->
    <div class="card-glass glas-all-style mt-3">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
            <div class="section-title mb-0">
                <i class="bi bi-list-check"></i> Detail Rows
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="pill">
                    <i class="bi bi-layers"></i>
                    Rows: <strong id="rowsCountBadge">
                        @(Model?.AdjustmentDetails?.Count() ?? 0)
                    </strong>
                </span>
                <div class="search-wrap">
                    <i class="bi bi-search"></i>
                    <input id="detailSearch"
                           type="search"
                           class="form-control"
                           placeholder="Search (Book / Barcode / Qty / Note)..." />
                </div>
            </div>
        </div>

        <div class="table-wrap mt-2">
            <table id="detailsTbl"
                   class="table table-sm table-hover table-striped table-bordered align-middle mb-0">
                <thead>
                    <tr>
                        <th><i class="bi bi-upc-scan me-1"></i>Book / Barcode</th>
                        <th style="width:120px;"><i class="bi bi-boxes me-1"></i>Qty</th>
                        <th><i class="bi bi-stickies me-1"></i>Note</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.AdjustmentDetails != null && Model.AdjustmentDetails.Any())
                    {
                        foreach (var d in Model.AdjustmentDetails.OrderBy(x => x.AdjustmentDetailId))
                        {
                            <tr>
                                <td>
                                    @(
                                        d?.Book == null
                                        ? "(no book)"
                                        : (string.IsNullOrEmpty(d.Book.Barcode)
                                        ? d.Book.Title
                                        : $"{d.Book.Title} ({d.Book.Barcode})")
                                        )
                                </td>
                                <td>@d.QuantityChanged</td>
                                <td>@d.Note</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                No detail rows.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const input = document.getElementById('detailSearch');
            const rows = Array.from(document.querySelectorAll('#detailsTbl tbody tr'));
            const badge = document.getElementById('rowsCountBadge');

            const norm = s => (s || '').toString().toLowerCase();
            const matchAll = (txt, q) => {
                const terms = norm(q).split(/\s+/).filter(Boolean);
                const t = norm(txt);
                return terms.every(w => t.includes(w));
            };

            function recalcVisibleCount() {
                const visible = rows.filter(tr => tr.style.display !== 'none').length;
                if (badge) {
                    badge.textContent = visible.toString();
                }
            }

            input?.addEventListener('input', e => {
                const q = e.target.value;
                rows.forEach(tr => {
                    const text = tr.innerText || tr.textContent || '';
                    tr.style.display = matchAll(text, q) ? '' : 'none';
                });
                recalcVisibleCount();
            });

            // initial
            recalcVisibleCount();
        })();
    </script>
}
